
> cms-backend@1.0.0 test
> jest

FAIL src/__tests__/services/VersionService.enhanced.test.ts (6.018 s)
  ‚óè Console

    console.error
      Error validating site access: Error: Database error
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.enhanced.test.ts:93:46)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 676 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 677 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 678 |[39m       console[33m.[39merror([32m'Error validating site access:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 679 |[39m       [36mreturn[39m {
     [90m 680 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 681 |[39m         error[33m:[39m [32m'Failed to validate site access'[39m[0m

      at VersionService.validateSiteAccess (src/services/VersionService.ts:678:15)
      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:95:24)

    console.error
      Error validating site access: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.validateSiteAccess (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:669:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:91:28)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.enhanced.test.ts:257:22)

    [0m [90m 676 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 677 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 678 |[39m       console[33m.[39merror([32m'Error validating site access:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 679 |[39m       [36mreturn[39m {
     [90m 680 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 681 |[39m         error[33m:[39m [32m'Failed to validate site access'[39m[0m

      at VersionService.validateSiteAccess (src/services/VersionService.ts:678:15)
      at VersionService.createVersion (src/services/VersionService.ts:91:28)
      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:257:22)

    console.error
      Error validating site access: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.validateSiteAccess (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:669:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:91:28)

    [0m [90m 676 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 677 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 678 |[39m       console[33m.[39merror([32m'Error validating site access:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 679 |[39m       [36mreturn[39m {
     [90m 680 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 681 |[39m         error[33m:[39m [32m'Failed to validate site access'[39m[0m

      at VersionService.validateSiteAccess (src/services/VersionService.ts:678:15)
      at VersionService.createVersion (src/services/VersionService.ts:91:28)

    console.error
      Error validating site access: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.validateSiteAccess (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:669:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:91:28)
          at VersionService.autoSave (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:868:20)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.enhanced.test.ts:334:22)

    [0m [90m 676 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 677 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 678 |[39m       console[33m.[39merror([32m'Error validating site access:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 679 |[39m       [36mreturn[39m {
     [90m 680 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 681 |[39m         error[33m:[39m [32m'Failed to validate site access'[39m[0m

      at VersionService.validateSiteAccess (src/services/VersionService.ts:678:15)
      at VersionService.createVersion (src/services/VersionService.ts:91:28)
      at VersionService.autoSave (src/services/VersionService.ts:868:20)
      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:334:22)

    console.error
      Error getting version metrics: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.getVersionMetrics (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:984:30)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.enhanced.test.ts:363:22)

    [0m [90m  998 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m metricsData }[33m;[39m
     [90m  999 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 1000 |[39m       console[33m.[39merror([32m'Error getting version metrics:'[39m[33m,[39m error)[33m;[39m
     [90m      |[39m               [31m[1m^[22m[39m
     [90m 1001 |[39m       [36mreturn[39m {
     [90m 1002 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 1003 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to get version metrics'[39m[0m

      at VersionService.getVersionMetrics (src/services/VersionService.ts:1000:15)
      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:363:22)

    console.error
      Error getting version metrics: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.getVersionMetrics (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:984:30)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.enhanced.test.ts:389:23)

    [0m [90m  998 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m metricsData }[33m;[39m
     [90m  999 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 1000 |[39m       console[33m.[39merror([32m'Error getting version metrics:'[39m[33m,[39m error)[33m;[39m
     [90m      |[39m               [31m[1m^[22m[39m
     [90m 1001 |[39m       [36mreturn[39m {
     [90m 1002 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 1003 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to get version metrics'[39m[0m

      at VersionService.getVersionMetrics (src/services/VersionService.ts:1000:15)
      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:389:23)

    console.error
      Error validating site access: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.validateSiteAccess (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:669:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:91:28)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.enhanced.test.ts:432:7)

    [0m [90m 676 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 677 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 678 |[39m       console[33m.[39merror([32m'Error validating site access:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 679 |[39m       [36mreturn[39m {
     [90m 680 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 681 |[39m         error[33m:[39m [32m'Failed to validate site access'[39m[0m

      at VersionService.validateSiteAccess (src/services/VersionService.ts:678:15)
      at VersionService.createVersion (src/services/VersionService.ts:91:28)
      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:432:7)

    console.error
      Error validating site access: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.validateSiteAccess (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:669:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:91:28)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.enhanced.test.ts:472:7)

    [0m [90m 676 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 677 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 678 |[39m       console[33m.[39merror([32m'Error validating site access:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 679 |[39m       [36mreturn[39m {
     [90m 680 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 681 |[39m         error[33m:[39m [32m'Failed to validate site access'[39m[0m

      at VersionService.validateSiteAccess (src/services/VersionService.ts:678:15)
      at VersionService.createVersion (src/services/VersionService.ts:91:28)
      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:472:7)

    console.error
      Error pruning auto-saves: TypeError: Cannot read properties of undefined (reading 'rowCount')
          at VersionService.pruneOldAutoSaves (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:1034:39)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.enhanced.test.ts:486:22)

    [0m [90m 1035 |[39m       }[33m;[39m
     [90m 1036 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 1037 |[39m       console[33m.[39merror([32m'Error pruning auto-saves:'[39m[33m,[39m error)[33m;[39m
     [90m      |[39m               [31m[1m^[22m[39m
     [90m 1038 |[39m       [36mreturn[39m {
     [90m 1039 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 1040 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to prune auto-saves'[39m[0m

      at VersionService.pruneOldAutoSaves (src/services/VersionService.ts:1037:15)
      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:486:22)

    console.error
      Error validating site access: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.validateSiteAccess (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:669:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:91:28)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.enhanced.test.ts:523:22)

    [0m [90m 676 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 677 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 678 |[39m       console[33m.[39merror([32m'Error validating site access:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 679 |[39m       [36mreturn[39m {
     [90m 680 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 681 |[39m         error[33m:[39m [32m'Failed to validate site access'[39m[0m

      at VersionService.validateSiteAccess (src/services/VersionService.ts:678:15)
      at VersionService.createVersion (src/services/VersionService.ts:91:28)
      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:523:22)

    console.error
      Error validating site access: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.validateSiteAccess (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:669:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:91:28)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.enhanced.test.ts:542:22)

    [0m [90m 676 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 677 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 678 |[39m       console[33m.[39merror([32m'Error validating site access:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 679 |[39m       [36mreturn[39m {
     [90m 680 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 681 |[39m         error[33m:[39m [32m'Failed to validate site access'[39m[0m

      at VersionService.validateSiteAccess (src/services/VersionService.ts:678:15)
      at VersionService.createVersion (src/services/VersionService.ts:91:28)
      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:542:22)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Enhanced Version Creation ‚Ä∫ should create version with enhanced security validation

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "SELECT 1 FROM sites", [1, 1]
    Received
           1: "SET TRANSACTION ISOLATION LEVEL REPEATABLE READ"
           2: "BEGIN"
           3
              "SELECT get_next_version_number($1, $2, $3) as version_number",
              Array [
                1,
            +   "post",
                1,
              ],

    Number of calls: 7

    [0m [90m 230 |[39m
     [90m 231 |[39m       [90m// Verify site access validation was called[39m
    [31m[1m>[22m[39m[90m 232 |[39m       expect(mockQuery)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                         [31m[1m^[22m[39m
     [90m 233 |[39m         expect[33m.[39mstringContaining([32m'SELECT 1 FROM sites'[39m)[33m,[39m
     [90m 234 |[39m         [[35m1[39m[33m,[39m [35m1[39m]
     [90m 235 |[39m       )[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:232:25)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Enhanced Version Creation ‚Ä∫ should respect version limits

    expect(received).toContain(expected) // indexOf

    Expected substring: "Maximum version limit"
    Received string:    "Failed to validate site access"

    [0m [90m 258 |[39m
     [90m 259 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 260 |[39m       expect(result[33m.[39merror)[33m.[39mtoContain([32m'Maximum version limit'[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 261 |[39m     })[33m;[39m
     [90m 262 |[39m   })[33m;[39m
     [90m 263 |[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:260:28)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Enhanced Draft Operations ‚Ä∫ should create draft with proper version type

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 295 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m versionService[33m.[39mcreateDraft(input[33m,[39m [35m1[39m)[33m;[39m
     [90m 296 |[39m
    [31m[1m>[22m[39m[90m 297 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 298 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mversion_type)[33m.[39mtoBe([32m'draft'[39m)[33m;[39m
     [90m 299 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mis_current_draft)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 300 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:297:30)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Auto-Save Features ‚Ä∫ should create auto-save version and trigger pruning

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 334 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m versionService[33m.[39mautoSave(input[33m,[39m [35m1[39m)[33m;[39m
     [90m 335 |[39m
    [31m[1m>[22m[39m[90m 336 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 337 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mversion_type)[33m.[39mtoBe([32m'auto_save'[39m)[33m;[39m
     [90m 338 |[39m
     [90m 339 |[39m       [90m// Wait a bit for async pruning to be called[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:336:30)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Version Metrics ‚Ä∫ should calculate comprehensive metrics

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 363 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m versionService[33m.[39mgetVersionMetrics([35m1[39m[33m,[39m [33mContentType[39m[33m.[39m[33mPOST[39m[33m,[39m [35m1[39m)[33m;[39m
     [90m 364 |[39m
    [31m[1m>[22m[39m[90m 365 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 366 |[39m       expect(result[33m.[39mdata)[33m.[39mtoEqual({
     [90m 367 |[39m         total_versions[33m:[39m [35m25[39m[33m,[39m
     [90m 368 |[39m         draft_count[33m:[39m [35m5[39m[33m,[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:365:30)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Version Metrics ‚Ä∫ should use cache for subsequent requests

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 388 |[39m       [90m// First call[39m
     [90m 389 |[39m       [36mconst[39m result1 [33m=[39m [36mawait[39m versionService[33m.[39mgetVersionMetrics([35m1[39m[33m,[39m [33mContentType[39m[33m.[39m[33mPOST[39m[33m,[39m [35m1[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 390 |[39m       expect(result1[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 391 |[39m
     [90m 392 |[39m       [90m// Second call should use cache[39m
     [90m 393 |[39m       [36mconst[39m result2 [33m=[39m [36mawait[39m versionService[33m.[39mgetVersionMetrics([35m1[39m[33m,[39m [33mContentType[39m[33m.[39m[33mPOST[39m[33m,[39m [35m1[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:390:31)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Event System ‚Ä∫ should emit events on version creation

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"action": "created", "siteId": 1, "userId": 1}

    Number of calls: 0

    [0m [90m 432 |[39m       [36mawait[39m versionService[33m.[39mcreateVersion(input[33m,[39m [35m1[39m)[33m;[39m
     [90m 433 |[39m
    [31m[1m>[22m[39m[90m 434 |[39m       expect(eventHandler)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 435 |[39m         expect[33m.[39mobjectContaining({
     [90m 436 |[39m           action[33m:[39m [33mVersionAction[39m[33m.[39m[33mCREATED[39m[33m,[39m
     [90m 437 |[39m           userId[33m:[39m [35m1[39m[33m,[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:434:28)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Event System ‚Ä∫ should support any event handler

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"action": "created"}

    Number of calls: 0

    [0m [90m 472 |[39m       [36mawait[39m versionService[33m.[39mcreateVersion(input[33m,[39m [35m1[39m)[33m;[39m
     [90m 473 |[39m
    [31m[1m>[22m[39m[90m 474 |[39m       expect(anyEventHandler)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 475 |[39m         expect[33m.[39mobjectContaining({
     [90m 476 |[39m           action[33m:[39m [33mVersionAction[39m[33m.[39m[33mCREATED[39m
     [90m 477 |[39m         })[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:474:31)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Performance Features ‚Ä∫ should prune old auto-save versions

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 486 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m versionService[33m.[39mpruneOldAutoSaves([35m1[39m[33m,[39m [33mContentType[39m[33m.[39m[33mPOST[39m[33m,[39m [35m1[39m)[33m;[39m
     [90m 487 |[39m
    [31m[1m>[22m[39m[90m 488 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 489 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mdeleted_count)[33m.[39mtoBe([35m5[39m)[33m;[39m
     [90m 490 |[39m
     [90m 491 |[39m       expect(mockQuery)[33m.[39mtoHaveBeenCalledWith([0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:488:30)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Error Handling ‚Ä∫ should handle database connection errors

    expect(received).toContain(expected) // indexOf

    Expected substring: "Connection failed"
    Received string:    "Failed to validate site access"

    [0m [90m 524 |[39m
     [90m 525 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 526 |[39m       expect(result[33m.[39merror)[33m.[39mtoContain([32m'Connection failed'[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 527 |[39m     })[33m;[39m
     [90m 528 |[39m
     [90m 529 |[39m     it([32m'should rollback transactions on failure'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:526:28)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Error Handling ‚Ä∫ should rollback transactions on failure

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "ROLLBACK"

    Number of calls: 0

    [0m [90m 543 |[39m
     [90m 544 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 545 |[39m       expect(mockClient[33m.[39mquery)[33m.[39mtoHaveBeenCalledWith([32m'ROLLBACK'[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 546 |[39m       expect(mockClient[33m.[39mrelease)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m 547 |[39m     })[33m;[39m
     [90m 548 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:545:32)

PASS src/__tests__/services/SubscriptionService.test.ts (6.593 s)
  ‚óè Console

    console.error
      Error getting subscription: Error: Database error
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\SubscriptionService.test.ts:262:43)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 202 |[39m       }[33m;[39m
     [90m 203 |[39m     } [36mcatch[39m (error[33m:[39m any) {
    [31m[1m>[22m[39m[90m 204 |[39m       console[33m.[39merror([32m'Error getting subscription:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 205 |[39m       [36mreturn[39m {
     [90m 206 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 207 |[39m         error[33m:[39m [32m'Failed to retrieve subscription'[39m[33m,[39m[0m

      at SubscriptionService.getCurrentSubscription (src/services/SubscriptionService.ts:204:15)
      at Object.<anonymous> (src/__tests__/services/SubscriptionService.test.ts:264:22)

FAIL src/__tests__/versions.test.ts (6.846 s)
  ‚óè Console

    console.error
      Error listing versions: TypeError: Cannot read properties of undefined (reading 'total')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\versions_simple.ts:45:50
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 56 |[39m       })[33m;[39m
     [90m 57 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 58 |[39m       console[33m.[39merror([32m'Error listing versions:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 59 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 60 |[39m     }
     [90m 61 |[39m   }[0m

      at src/routes/versions_simple.ts:58:15

    console.error
      Error listing versions: TypeError: Cannot read properties of undefined (reading 'total')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\versions_simple.ts:45:50
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 56 |[39m       })[33m;[39m
     [90m 57 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 58 |[39m       console[33m.[39merror([32m'Error listing versions:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 59 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 60 |[39m     }
     [90m 61 |[39m   }[0m

      at src/routes/versions_simple.ts:58:15

    console.error
      Error publishing version: TypeError: Cannot read properties of undefined (reading 'release')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\versions_simple.ts:294:16
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 295 |[39m       }
     [90m 296 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 297 |[39m       console[33m.[39merror([32m'Error publishing version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 298 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 299 |[39m     }
     [90m 300 |[39m   }[0m

      at src/routes/versions_simple.ts:297:15

  ‚óè Version API Endpoints ‚Ä∫ GET /api/content/:contentType/:contentId/versions ‚Ä∫ should list versions for a content item

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 171 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 172 |[39m
    [31m[1m>[22m[39m[90m 173 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 174 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 175 |[39m       expect(response[33m.[39mbody[33m.[39mdata)[33m.[39mtoHaveLength([35m2[39m)[33m;[39m
     [90m 176 |[39m       expect(response[33m.[39mbody[33m.[39mpagination)[33m.[39mtoBeDefined()[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:173:31)

  ‚óè Version API Endpoints ‚Ä∫ GET /api/content/:contentType/:contentId/versions ‚Ä∫ should return 404 for non-existent content

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 500

    [0m [90m 192 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 193 |[39m
    [31m[1m>[22m[39m[90m 194 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 195 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'not found'[39m)[33m;[39m
     [90m 196 |[39m     })[33m;[39m
     [90m 197 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:194:31)

  ‚óè Version API Endpoints ‚Ä∫ POST /api/content/:contentType/:contentId/versions ‚Ä∫ should create a new version

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 401

    [0m [90m 210 |[39m         })[33m;[39m
     [90m 211 |[39m
    [31m[1m>[22m[39m[90m 212 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 213 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 214 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mtitle)[33m.[39mtoBe([32m'Test Version'[39m)[33m;[39m
     [90m 215 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:212:31)

  ‚óè Version API Endpoints ‚Ä∫ POST /api/content/:contentType/:contentId/versions ‚Ä∫ should validate required fields

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 401

    [0m [90m 225 |[39m         })[33m;[39m
     [90m 226 |[39m
    [31m[1m>[22m[39m[90m 227 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 228 |[39m     })[33m;[39m
     [90m 229 |[39m
     [90m 230 |[39m     it([32m'should check content ownership for authors'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:227:31)

  ‚óè Version API Endpoints ‚Ä∫ POST /api/content/:contentType/:contentId/versions ‚Ä∫ should check content ownership for authors

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 401

    [0m [90m 248 |[39m         })[33m;[39m
     [90m 249 |[39m
    [31m[1m>[22m[39m[90m 250 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m403[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 251 |[39m     })[33m;[39m
     [90m 252 |[39m   })[33m;[39m
     [90m 253 |[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:250:31)

  ‚óè Version API Endpoints ‚Ä∫ GET /api/versions/:versionId ‚Ä∫ should get a specific version

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 260 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 261 |[39m
    [31m[1m>[22m[39m[90m 262 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 263 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 264 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mid)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m 265 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:262:31)

  ‚óè Version API Endpoints ‚Ä∫ GET /api/versions/:versionId ‚Ä∫ should check version access

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 275 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 276 |[39m
    [31m[1m>[22m[39m[90m 277 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m [90m// GET is allowed for all authenticated users[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 278 |[39m     })[33m;[39m
     [90m 279 |[39m   })[33m;[39m
     [90m 280 |[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:277:31)

  ‚óè Version API Endpoints ‚Ä∫ PUT /api/versions/:versionId ‚Ä∫ should update a draft version

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 290 |[39m         })[33m;[39m
     [90m 291 |[39m
    [31m[1m>[22m[39m[90m 292 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 293 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 294 |[39m     })[33m;[39m
     [90m 295 |[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:292:31)

  ‚óè Version API Endpoints ‚Ä∫ PUT /api/versions/:versionId ‚Ä∫ should prevent updating published versions

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 401

    [0m [90m 310 |[39m         })[33m;[39m
     [90m 311 |[39m
    [31m[1m>[22m[39m[90m 312 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 313 |[39m     })[33m;[39m
     [90m 314 |[39m   })[33m;[39m
     [90m 315 |[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:312:31)

  ‚óè Version API Endpoints ‚Ä∫ POST /api/versions/:versionId/publish ‚Ä∫ should publish a version

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 322 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 323 |[39m
    [31m[1m>[22m[39m[90m 324 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 325 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 326 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'published successfully'[39m)[33m;[39m
     [90m 327 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:324:31)

  ‚óè Version API Endpoints ‚Ä∫ POST /api/versions/:versionId/revert ‚Ä∫ should create new draft from version

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 350 |[39m         })[33m;[39m
     [90m 351 |[39m
    [31m[1m>[22m[39m[90m 352 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 353 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 354 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'created new draft'[39m)[33m;[39m
     [90m 355 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:352:31)

  ‚óè Version API Endpoints ‚Ä∫ DELETE /api/versions/:versionId ‚Ä∫ should delete a version

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 364 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 365 |[39m
    [31m[1m>[22m[39m[90m 366 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 367 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 368 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'deleted successfully'[39m)[33m;[39m
     [90m 369 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:366:31)

  ‚óè Version API Endpoints ‚Ä∫ GET /api/content/:contentType/:contentId/versions/latest ‚Ä∫ should get latest draft version

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 378 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 379 |[39m
    [31m[1m>[22m[39m[90m 380 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 381 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 382 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mtitle)[33m.[39mtoBe([32m'Latest Draft'[39m)[33m;[39m
     [90m 383 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:380:31)

  ‚óè Version API Endpoints ‚Ä∫ GET /api/content/:contentType/:contentId/versions/latest ‚Ä∫ should get published version

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 390 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 391 |[39m
    [31m[1m>[22m[39m[90m 392 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 393 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 394 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mtitle)[33m.[39mtoBe([32m'Published Version'[39m)[33m;[39m
     [90m 395 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:392:31)

  ‚óè Version API Endpoints ‚Ä∫ GET /api/versions/:versionId/diff ‚Ä∫ should compare two versions

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 404 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 405 |[39m
    [31m[1m>[22m[39m[90m 406 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 407 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 408 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mchanges)[33m.[39mtoHaveLength([35m1[39m)[33m;[39m
     [90m 409 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:406:31)

  ‚óè Version API Endpoints ‚Ä∫ GET /api/versions/:versionId/diff ‚Ä∫ should validate versions belong to same content

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 404

    [0m [90m 427 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 428 |[39m
    [31m[1m>[22m[39m[90m 429 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 430 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'same content'[39m)[33m;[39m
     [90m 431 |[39m     })[33m;[39m
     [90m 432 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:429:31)

PASS src/__tests__/services/QuotaService.test.ts
  ‚óè Console

    console.error
      Error decrementing quota: Error: Database error
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\QuotaService.test.ts:423:45)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 325 |[39m         }
     [90m 326 |[39m       }
    [31m[1m>[22m[39m[90m 327 |[39m       console[33m.[39merror([32m'Error decrementing quota:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 328 |[39m       [36mreturn[39m {
     [90m 329 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 330 |[39m         error[33m:[39m error[33m.[39mmessage [33m||[39m [32m'Failed to decrement quota'[39m[33m,[39m[0m

      at QuotaService.decrementQuota (src/services/QuotaService.ts:327:15)
      at Object.<anonymous> (src/__tests__/services/QuotaService.test.ts:425:22)

    console.error
      Error decrementing quota: Error: Connection pool exhausted
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\QuotaService.test.ts:450:45)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 325 |[39m         }
     [90m 326 |[39m       }
    [31m[1m>[22m[39m[90m 327 |[39m       console[33m.[39merror([32m'Error decrementing quota:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 328 |[39m       [36mreturn[39m {
     [90m 329 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 330 |[39m         error[33m:[39m error[33m.[39mmessage [33m||[39m [32m'Failed to decrement quota'[39m[33m,[39m[0m

      at QuotaService.decrementQuota (src/services/QuotaService.ts:327:15)
      at Object.<anonymous> (src/__tests__/services/QuotaService.test.ts:452:22)

    console.error
      Error checking quota: Error: Database connection failed
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\QuotaService.test.ts:744:43)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 133 |[39m       }[33m;[39m
     [90m 134 |[39m     } [36mcatch[39m (error[33m:[39m any) {
    [31m[1m>[22m[39m[90m 135 |[39m       console[33m.[39merror([32m'Error checking quota:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 136 |[39m       [36mreturn[39m {
     [90m 137 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 138 |[39m         error[33m:[39m error[33m.[39mmessage [33m||[39m [32m'Failed to check quota'[39m[33m,[39m[0m

      at QuotaService.checkQuota (src/services/QuotaService.ts:135:15)
      at Object.<anonymous> (src/__tests__/services/QuotaService.test.ts:746:22)

FAIL src/__tests__/services/VersionService.autosave.test.ts (7.137 s)
  ‚óè Console

    console.error
      Error creating version: TypeError: Cannot read properties of undefined (reading 'version_number')
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:123:57)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createAutoSave (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:1080:22)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.autosave.test.ts:136:22)

    [0m [90m 216 |[39m     } [36mcatch[39m (error) {
     [90m 217 |[39m       [36mawait[39m client[33m.[39mquery([32m'ROLLBACK'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 218 |[39m       console[33m.[39merror([32m'Error creating version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 219 |[39m       [36mreturn[39m {
     [90m 220 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 221 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to create version'[39m[0m

      at VersionService.createVersion (src/services/VersionService.ts:218:15)
      at VersionService.createAutoSave (src/services/VersionService.ts:1080:22)
      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:136:22)

    console.error
      Error creating version: TypeError: Cannot read properties of undefined (reading 'version_number')
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:123:57)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createAutoSave (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:1080:22)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.autosave.test.ts:150:7)

    [0m [90m 216 |[39m     } [36mcatch[39m (error) {
     [90m 217 |[39m       [36mawait[39m client[33m.[39mquery([32m'ROLLBACK'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 218 |[39m       console[33m.[39merror([32m'Error creating version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 219 |[39m       [36mreturn[39m {
     [90m 220 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 221 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to create version'[39m[0m

      at VersionService.createVersion (src/services/VersionService.ts:218:15)
      at VersionService.createAutoSave (src/services/VersionService.ts:1080:22)
      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:150:7)

    console.error
      Error creating version: TypeError: Cannot read properties of undefined (reading 'version_number')
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:123:57)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createAutoSave (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:1080:22)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.autosave.test.ts:165:22)

    [0m [90m 216 |[39m     } [36mcatch[39m (error) {
     [90m 217 |[39m       [36mawait[39m client[33m.[39mquery([32m'ROLLBACK'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 218 |[39m       console[33m.[39merror([32m'Error creating version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 219 |[39m       [36mreturn[39m {
     [90m 220 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 221 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to create version'[39m[0m

      at VersionService.createVersion (src/services/VersionService.ts:218:15)
      at VersionService.createAutoSave (src/services/VersionService.ts:1080:22)
      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:165:22)

    console.error
      Error creating version: TypeError: Cannot read properties of undefined (reading 'version_number')
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:123:57)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createAutoSave (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:1080:22)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.autosave.test.ts:195:22)

    [0m [90m 216 |[39m     } [36mcatch[39m (error) {
     [90m 217 |[39m       [36mawait[39m client[33m.[39mquery([32m'ROLLBACK'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 218 |[39m       console[33m.[39merror([32m'Error creating version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 219 |[39m       [36mreturn[39m {
     [90m 220 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 221 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to create version'[39m[0m

      at VersionService.createVersion (src/services/VersionService.ts:218:15)
      at VersionService.createAutoSave (src/services/VersionService.ts:1080:22)
      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:195:22)

    console.error
      Error getting content hash: Error: Database connection failed
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.autosave.test.ts:204:35)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 1200 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m result[33m.[39mrows[[35m0[39m][33m.[39mcontent_hash }[33m;[39m
     [90m 1201 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 1202 |[39m       console[33m.[39merror([32m'Error getting content hash:'[39m[33m,[39m error)[33m;[39m
     [90m      |[39m               [31m[1m^[22m[39m
     [90m 1203 |[39m       [36mreturn[39m {
     [90m 1204 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 1205 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to get content hash'[39m[0m

      at VersionService.getLatestContentHash (src/services/VersionService.ts:1202:15)
      at VersionService.createAutoSave (src/services/VersionService.ts:1065:30)
      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:206:22)

    console.error
      Error validating site access: Error: Database connection failed
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.autosave.test.ts:204:35)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 676 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 677 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 678 |[39m       console[33m.[39merror([32m'Error validating site access:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 679 |[39m       [36mreturn[39m {
     [90m 680 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 681 |[39m         error[33m:[39m [32m'Failed to validate site access'[39m[0m

      at VersionService.validateSiteAccess (src/services/VersionService.ts:678:15)
      at VersionService.createVersion (src/services/VersionService.ts:91:28)
      at VersionService.createAutoSave (src/services/VersionService.ts:1080:22)
      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:206:22)

    console.error
      Error creating version: TypeError: Cannot read properties of undefined (reading 'version_number')
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:123:57)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createAutoSave (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:1080:22)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.autosave.test.ts:213:22)

    [0m [90m 216 |[39m     } [36mcatch[39m (error) {
     [90m 217 |[39m       [36mawait[39m client[33m.[39mquery([32m'ROLLBACK'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 218 |[39m       console[33m.[39merror([32m'Error creating version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 219 |[39m       [36mreturn[39m {
     [90m 220 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 221 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to create version'[39m[0m

      at VersionService.createVersion (src/services/VersionService.ts:218:15)
      at VersionService.createAutoSave (src/services/VersionService.ts:1080:22)
      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:213:22)

    console.error
      Error getting latest auto-save: Error: Query failed
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.autosave.test.ts:286:39)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 1132 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m result[33m.[39mrows[[35m0[39m] }[33m;[39m
     [90m 1133 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 1134 |[39m       console[33m.[39merror([32m'Error getting latest auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m      |[39m               [31m[1m^[22m[39m
     [90m 1135 |[39m       [36mreturn[39m {
     [90m 1136 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 1137 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to get latest auto-save'[39m[0m

      at VersionService.getLatestAutoSave (src/services/VersionService.ts:1134:15)
      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:288:22)

    console.error
      Error getting content hash: Error: Database error
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.autosave.test.ts:406:39)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 1200 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m result[33m.[39mrows[[35m0[39m][33m.[39mcontent_hash }[33m;[39m
     [90m 1201 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 1202 |[39m       console[33m.[39merror([32m'Error getting content hash:'[39m[33m,[39m error)[33m;[39m
     [90m      |[39m               [31m[1m^[22m[39m
     [90m 1203 |[39m       [36mreturn[39m {
     [90m 1204 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 1205 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to get content hash'[39m[0m

      at VersionService.getLatestContentHash (src/services/VersionService.ts:1202:15)
      at VersionService.hasUnsavedChanges (src/services/VersionService.ts:1152:26)
      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:408:22)

    console.error
      Error pruning auto-saves: Error: Cleanup failed
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.autosave.test.ts:485:39)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 1035 |[39m       }[33m;[39m
     [90m 1036 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 1037 |[39m       console[33m.[39merror([32m'Error pruning auto-saves:'[39m[33m,[39m error)[33m;[39m
     [90m      |[39m               [31m[1m^[22m[39m
     [90m 1038 |[39m       [36mreturn[39m {
     [90m 1039 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 1040 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to prune auto-saves'[39m[0m

      at VersionService.pruneOldAutoSaves (src/services/VersionService.ts:1037:15)
      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:487:22)

    console.error
      Error creating version: TypeError: Cannot read properties of undefined (reading 'version_number')
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:123:57)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createAutoSave (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:1080:22)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.autosave.test.ts:577:23)

    [0m [90m 216 |[39m     } [36mcatch[39m (error) {
     [90m 217 |[39m       [36mawait[39m client[33m.[39mquery([32m'ROLLBACK'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 218 |[39m       console[33m.[39merror([32m'Error creating version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 219 |[39m       [36mreturn[39m {
     [90m 220 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 221 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to create version'[39m[0m

      at VersionService.createVersion (src/services/VersionService.ts:218:15)
      at VersionService.createAutoSave (src/services/VersionService.ts:1080:22)
      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:577:23)

    console.error
      Error creating version: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:123:49)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createAutoSave (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:1080:22)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.autosave.test.ts:578:23)

    [0m [90m 216 |[39m     } [36mcatch[39m (error) {
     [90m 217 |[39m       [36mawait[39m client[33m.[39mquery([32m'ROLLBACK'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 218 |[39m       console[33m.[39merror([32m'Error creating version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 219 |[39m       [36mreturn[39m {
     [90m 220 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 221 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to create version'[39m[0m

      at VersionService.createVersion (src/services/VersionService.ts:218:15)
      at VersionService.createAutoSave (src/services/VersionService.ts:1080:22)
      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:578:23)

    console.error
      Error creating version: TypeError: Cannot read properties of undefined (reading 'version_number')
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:123:57)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createAutoSave (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:1080:22)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.autosave.test.ts:606:22)

    [0m [90m 216 |[39m     } [36mcatch[39m (error) {
     [90m 217 |[39m       [36mawait[39m client[33m.[39mquery([32m'ROLLBACK'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 218 |[39m       console[33m.[39merror([32m'Error creating version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 219 |[39m       [36mreturn[39m {
     [90m 220 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 221 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to create version'[39m[0m

      at VersionService.createVersion (src/services/VersionService.ts:218:15)
      at VersionService.createAutoSave (src/services/VersionService.ts:1080:22)
      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:606:22)

  ‚óè VersionService Auto-Save Features ‚Ä∫ createAutoSave ‚Ä∫ should create auto-save version successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 136 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mcreateAutoSave(baseInput[33m,[39m testUserId[33m,[39m testSiteId)[33m;[39m
     [90m 137 |[39m
    [31m[1m>[22m[39m[90m 138 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 139 |[39m       expect(result[33m.[39mdata)[33m.[39mtoBeDefined()[33m;[39m
     [90m 140 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mversion_type)[33m.[39mtoBe([32m'auto_save'[39m)[33m;[39m
     [90m 141 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mcontent_hash)[33m.[39mtoBe(baseInput[33m.[39mcontent_hash)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:138:30)

  ‚óè VersionService Auto-Save Features ‚Ä∫ createAutoSave ‚Ä∫ should detect content changes via hash comparison

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 165 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mcreateAutoSave(baseInput[33m,[39m testUserId[33m,[39m testSiteId)[33m;[39m
     [90m 166 |[39m
    [31m[1m>[22m[39m[90m 167 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 168 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mcontent_hash)[33m.[39mtoBe(baseInput[33m.[39mcontent_hash)[33m;[39m
     [90m 169 |[39m     })[33m;[39m
     [90m 170 |[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:167:30)

  ‚óè VersionService Auto-Save Features ‚Ä∫ createAutoSave ‚Ä∫ should handle missing content hash gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 195 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mcreateAutoSave(inputWithoutHash[33m,[39m testUserId[33m,[39m testSiteId)[33m;[39m
     [90m 196 |[39m
    [31m[1m>[22m[39m[90m 197 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 198 |[39m       [90m// Should proceed without hash validation[39m
     [90m 199 |[39m       expect(mockQuery)[33m.[39mtoHaveBeenCalledWith([32m'BEGIN'[39m)[33m;[39m
     [90m 200 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:197:30)

  ‚óè VersionService Auto-Save Features ‚Ä∫ createAutoSave ‚Ä∫ should trigger cleanup of old auto-saves after successful creation

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 213 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mcreateAutoSave(baseInput[33m,[39m testUserId[33m,[39m testSiteId)[33m;[39m
     [90m 214 |[39m
    [31m[1m>[22m[39m[90m 215 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 216 |[39m
     [90m 217 |[39m       [90m// Wait for async cleanup to be called[39m
     [90m 218 |[39m       [36mawait[39m [36mnew[39m [33mPromise[39m(resolve [33m=>[39m setTimeout(resolve[33m,[39m [35m10[39m))[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:215:30)

  ‚óè VersionService Auto-Save Features ‚Ä∫ hasUnsavedChanges ‚Ä∫ should query for latest non-auto-save version

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

    - StringContaining "version_type != 'auto_save'",
    + "
            SELECT content_hash
            FROM content_versions
            WHERE site_id = $1
              AND content_type = $2
              AND content_id = $3
              AND content_hash IS NOT NULL
            ORDER BY created_at DESC
            LIMIT 1
          ",
      [1, "post", 123],

    Number of calls: 1

    [0m [90m 397 |[39m       )[33m;[39m
     [90m 398 |[39m
    [31m[1m>[22m[39m[90m 399 |[39m       expect(mockQuery)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                         [31m[1m^[22m[39m
     [90m 400 |[39m         expect[33m.[39mstringContaining([32m"version_type != 'auto_save'"[39m)[33m,[39m
     [90m 401 |[39m         [testSiteId[33m,[39m [32m'post'[39m[33m,[39m testContentId]
     [90m 402 |[39m       )[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:399:25)

  ‚óè VersionService Auto-Save Features ‚Ä∫ cleanupOldAutoSaves ‚Ä∫ should order by creation date descending for deletion

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "ORDER BY created_at DESC", Anything
    Received: "
            DELETE FROM content_versions
            WHERE site_id = $1
              AND content_type = $2
              AND content_id = $3
              AND version_type = 'auto_save'
              AND created_at < $4
              AND NOT is_current_draft
              AND NOT is_current_published", [1, "post", 123, 2025-10-24T09:45:08.641Z]

    Number of calls: 1

    [0m [90m 504 |[39m       )[33m;[39m
     [90m 505 |[39m
    [31m[1m>[22m[39m[90m 506 |[39m       expect(mockQuery)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                         [31m[1m^[22m[39m
     [90m 507 |[39m         expect[33m.[39mstringContaining([32m'ORDER BY created_at DESC'[39m)[33m,[39m
     [90m 508 |[39m         expect[33m.[39manything()
     [90m 509 |[39m       )[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:506:25)

  ‚óè VersionService Auto-Save Features ‚Ä∫ Auto-Save Integration Scenarios ‚Ä∫ should handle rapid successive auto-save attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 578 |[39m       [36mconst[39m result2 [33m=[39m [36mawait[39m service[33m.[39mcreateAutoSave(input2[33m,[39m testUserId[33m,[39m testSiteId)[33m;[39m
     [90m 579 |[39m
    [31m[1m>[22m[39m[90m 580 |[39m       expect(result1[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 581 |[39m       expect(result2[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 582 |[39m       expect(result1[33m.[39mdata[33m?[39m[33m.[39mcontent_hash)[33m.[39mtoBe([32m'hash1'[39m)[33m;[39m
     [90m 583 |[39m       expect(result2[33m.[39mdata[33m?[39m[33m.[39mcontent_hash)[33m.[39mtoBe([32m'hash2'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:580:31)

  ‚óè VersionService Auto-Save Features ‚Ä∫ Auto-Save Integration Scenarios ‚Ä∫ should handle auto-save creation with concurrent manual saves

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 606 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mcreateAutoSave(autoSaveInput[33m,[39m testUserId[33m,[39m testSiteId)[33m;[39m
     [90m 607 |[39m
    [31m[1m>[22m[39m[90m 608 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 609 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mcontent_hash)[33m.[39mtoBe([32m'auto_hash'[39m)[33m;[39m
     [90m 610 |[39m     })[33m;[39m
     [90m 611 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:608:30)

PASS src/__tests__/utils/password.test.ts
PASS src/__tests__/services/MemberService.cache.test.ts
PASS src/__tests__/integration/sf010-quota-enforcement.integration.test.ts
  ‚óè Console

    console.log
      [QuotaEnforcement] Quota check passed for org 1, dimension sites { current: 3, limit: 10, remaining: 7 }

      at src/middleware/quota.ts:168:15

    console.warn
      [QuotaEnforcement] Quota exceeded for org 1, dimension sites { current: 10, limit: 10, tier: 'pro' }

    [0m [90m 141 |[39m       [36mif[39m ([33m![39mresult[33m.[39mdata[33m?[39m[33m.[39mallowed) {
     [90m 142 |[39m         [90m// Quota exceeded - log event[39m
    [31m[1m>[22m[39m[90m 143 |[39m         console[33m.[39mwarn([32m`[QuotaEnforcement] Quota exceeded for org ${organizationId}, dimension ${dimension}`[39m[33m,[39m {
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 144 |[39m           current[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mcurrent[33m,[39m
     [90m 145 |[39m           limit[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mlimit[33m,[39m
     [90m 146 |[39m           tier[33m:[39m tier[33m.[39mplanTier[33m,[39m[0m

      at src/middleware/quota.ts:143:17

    console.log
      [QuotaEnforcement] Enterprise tier - bypassing quota check for org 1, dimension sites

      at src/middleware/quota.ts:119:17

    console.log
      [QuotaEnforcement] Quota check passed for org 1, dimension posts { current: 50, limit: 100, remaining: 50 }

      at src/middleware/quota.ts:168:15

    console.warn
      [QuotaEnforcement] Quota exceeded for org 1, dimension posts { current: 100, limit: 100, tier: 'pro' }

    [0m [90m 141 |[39m       [36mif[39m ([33m![39mresult[33m.[39mdata[33m?[39m[33m.[39mallowed) {
     [90m 142 |[39m         [90m// Quota exceeded - log event[39m
    [31m[1m>[22m[39m[90m 143 |[39m         console[33m.[39mwarn([32m`[QuotaEnforcement] Quota exceeded for org ${organizationId}, dimension ${dimension}`[39m[33m,[39m {
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 144 |[39m           current[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mcurrent[33m,[39m
     [90m 145 |[39m           limit[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mlimit[33m,[39m
     [90m 146 |[39m           tier[33m:[39m tier[33m.[39mplanTier[33m,[39m[0m

      at src/middleware/quota.ts:143:17

    console.log
      [QuotaEnforcement] Quota check passed for org 1, dimension storage_bytes { current: 1048576, limit: 10485760, remaining: 9437184 }

      at src/middleware/quota.ts:168:15

    console.warn
      [QuotaEnforcement] Quota exceeded for org 1, dimension storage_bytes { current: 10485760, limit: 10485760, tier: 'pro' }

    [0m [90m 141 |[39m       [36mif[39m ([33m![39mresult[33m.[39mdata[33m?[39m[33m.[39mallowed) {
     [90m 142 |[39m         [90m// Quota exceeded - log event[39m
    [31m[1m>[22m[39m[90m 143 |[39m         console[33m.[39mwarn([32m`[QuotaEnforcement] Quota exceeded for org ${organizationId}, dimension ${dimension}`[39m[33m,[39m {
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 144 |[39m           current[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mcurrent[33m,[39m
     [90m 145 |[39m           limit[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mlimit[33m,[39m
     [90m 146 |[39m           tier[33m:[39m tier[33m.[39mplanTier[33m,[39m[0m

      at src/middleware/quota.ts:143:17

    console.log
      [QuotaEnforcement] Quota check passed for org 1, dimension storage_bytes { current: 2097152, limit: 10485760, remaining: 8388608 }

      at src/middleware/quota.ts:168:15

    console.warn
      [QuotaEnforcement] Quota exceeded for org 1, dimension storage_bytes { current: 10485760, limit: 10485760, tier: 'pro' }

    [0m [90m 141 |[39m       [36mif[39m ([33m![39mresult[33m.[39mdata[33m?[39m[33m.[39mallowed) {
     [90m 142 |[39m         [90m// Quota exceeded - log event[39m
    [31m[1m>[22m[39m[90m 143 |[39m         console[33m.[39mwarn([32m`[QuotaEnforcement] Quota exceeded for org ${organizationId}, dimension ${dimension}`[39m[33m,[39m {
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 144 |[39m           current[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mcurrent[33m,[39m
     [90m 145 |[39m           limit[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mlimit[33m,[39m
     [90m 146 |[39m           tier[33m:[39m tier[33m.[39mplanTier[33m,[39m[0m

      at src/middleware/quota.ts:143:17

    console.log
      [QuotaEnforcement] Quota check passed for org 1, dimension sites { current: 3, limit: 10, remaining: 7 }

      at src/middleware/quota.ts:168:15

    console.log
      [QuotaEnforcement] Quota check passed for org 1, dimension sites { current: 3, limit: 10, remaining: 7 }

      at src/middleware/quota.ts:168:15

PASS src/__tests__/middleware/quota.test.ts
  ‚óè Console

    console.log
      [QuotaEnforcement] Quota check passed for org 1, dimension sites { current: 5, limit: 10, remaining: 5 }

      at src/middleware/quota.ts:168:15

    console.log
      [QuotaEnforcement] Quota check passed for org 1, dimension sites { current: 2, limit: 5, remaining: 3 }

      at src/middleware/quota.ts:168:15

    console.log
      [QuotaEnforcement] Quota check passed for org 1, dimension sites { current: 1, limit: 3, remaining: 2 }

      at src/middleware/quota.ts:168:15

    console.error
      Error fetching subscription tier: Error: Database connection error
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\middleware\quota.test.ts:153:52)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 73 |[39m     [36mreturn[39m tier[33m;[39m
     [90m 74 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 75 |[39m     console[33m.[39merror([32m'Error fetching subscription tier:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 76 |[39m     [90m// On error, assume free tier (fail-safe)[39m
     [90m 77 |[39m     [36mreturn[39m {
     [90m 78 |[39m       planTier[33m:[39m [32m'free'[39m[33m,[39m[0m

      at getSubscriptionTier (src/middleware/quota.ts:75:13)
      at src/middleware/quota.ts:105:20
      at Object.<anonymous> (src/__tests__/middleware/quota.test.ts:166:7)

    console.warn
      [QuotaEnforcement] Quota exceeded for org 1, dimension sites { current: 3, limit: 3, tier: 'free' }

    [0m [90m 141 |[39m       [36mif[39m ([33m![39mresult[33m.[39mdata[33m?[39m[33m.[39mallowed) {
     [90m 142 |[39m         [90m// Quota exceeded - log event[39m
    [31m[1m>[22m[39m[90m 143 |[39m         console[33m.[39mwarn([32m`[QuotaEnforcement] Quota exceeded for org ${organizationId}, dimension ${dimension}`[39m[33m,[39m {
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 144 |[39m           current[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mcurrent[33m,[39m
     [90m 145 |[39m           limit[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mlimit[33m,[39m
     [90m 146 |[39m           tier[33m:[39m tier[33m.[39mplanTier[33m,[39m[0m

      at src/middleware/quota.ts:143:17
      at Object.<anonymous> (src/__tests__/middleware/quota.test.ts:166:7)

    console.log
      [QuotaEnforcement] Enterprise tier - bypassing quota check for org 1, dimension sites

      at src/middleware/quota.ts:119:17

    console.log
      [QuotaEnforcement] Enterprise tier - bypassing quota check for org 1, dimension posts

      at src/middleware/quota.ts:119:17

    console.log
      [QuotaEnforcement] Quota check passed for org 1, dimension sites { current: 5, limit: 20, remaining: 15 }

      at src/middleware/quota.ts:168:15

    console.log
      [QuotaEnforcement] Quota check passed for org 1, dimension sites { current: 100, limit: 1000, remaining: 900 }

      at src/middleware/quota.ts:168:15

    console.log
      [QuotaEnforcement] Quota check passed for org 1, dimension posts { current: 100, limit: 1000, remaining: 900 }

      at src/middleware/quota.ts:168:15

    console.log
      [QuotaEnforcement] Quota check passed for org 1, dimension users { current: 100, limit: 1000, remaining: 900 }

      at src/middleware/quota.ts:168:15

    console.log
      [QuotaEnforcement] Quota check passed for org 1, dimension storage_bytes { current: 100, limit: 1000, remaining: 900 }

      at src/middleware/quota.ts:168:15

    console.warn
      [QuotaEnforcement] Quota exceeded for org 1, dimension sites { current: 3, limit: 3, tier: 'free' }

    [0m [90m 141 |[39m       [36mif[39m ([33m![39mresult[33m.[39mdata[33m?[39m[33m.[39mallowed) {
     [90m 142 |[39m         [90m// Quota exceeded - log event[39m
    [31m[1m>[22m[39m[90m 143 |[39m         console[33m.[39mwarn([32m`[QuotaEnforcement] Quota exceeded for org ${organizationId}, dimension ${dimension}`[39m[33m,[39m {
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 144 |[39m           current[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mcurrent[33m,[39m
     [90m 145 |[39m           limit[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mlimit[33m,[39m
     [90m 146 |[39m           tier[33m:[39m tier[33m.[39mplanTier[33m,[39m[0m

      at src/middleware/quota.ts:143:17
      at Object.<anonymous> (src/__tests__/middleware/quota.test.ts:288:7)

    console.warn
      [QuotaEnforcement] Quota exceeded for org 1, dimension posts { current: 10, limit: 10, tier: 'free' }

    [0m [90m 141 |[39m       [36mif[39m ([33m![39mresult[33m.[39mdata[33m?[39m[33m.[39mallowed) {
     [90m 142 |[39m         [90m// Quota exceeded - log event[39m
    [31m[1m>[22m[39m[90m 143 |[39m         console[33m.[39mwarn([32m`[QuotaEnforcement] Quota exceeded for org ${organizationId}, dimension ${dimension}`[39m[33m,[39m {
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 144 |[39m           current[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mcurrent[33m,[39m
     [90m 145 |[39m           limit[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mlimit[33m,[39m
     [90m 146 |[39m           tier[33m:[39m tier[33m.[39mplanTier[33m,[39m[0m

      at src/middleware/quota.ts:143:17
      at Object.<anonymous> (src/__tests__/middleware/quota.test.ts:325:7)

    console.warn
      [QuotaEnforcement] Quota exceeded for org 1, dimension storage_bytes { current: 5, limit: 5, tier: 'free' }

    [0m [90m 141 |[39m       [36mif[39m ([33m![39mresult[33m.[39mdata[33m?[39m[33m.[39mallowed) {
     [90m 142 |[39m         [90m// Quota exceeded - log event[39m
    [31m[1m>[22m[39m[90m 143 |[39m         console[33m.[39mwarn([32m`[QuotaEnforcement] Quota exceeded for org ${organizationId}, dimension ${dimension}`[39m[33m,[39m {
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 144 |[39m           current[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mcurrent[33m,[39m
     [90m 145 |[39m           limit[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mlimit[33m,[39m
     [90m 146 |[39m           tier[33m:[39m tier[33m.[39mplanTier[33m,[39m[0m

      at src/middleware/quota.ts:143:17
      at Object.<anonymous> (src/__tests__/middleware/quota.test.ts:357:7)

    console.error
      [QuotaEnforcement] Service error checking quota: Database connection failed

    [0m [90m 130 |[39m       [36mif[39m ([33m![39mresult[33m.[39msuccess) {
     [90m 131 |[39m         [90m// Service error (not quota exceeded, but something went wrong)[39m
    [31m[1m>[22m[39m[90m 132 |[39m         console[33m.[39merror([32m`[QuotaEnforcement] Service error checking quota: ${result.error}`[39m)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 133 |[39m         [36mreturn[39m res[33m.[39mstatus([35m500[39m)[33m.[39mjson({
     [90m 134 |[39m           success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 135 |[39m           error[33m:[39m result[33m.[39merror[33m,[39m[0m

      at src/middleware/quota.ts:132:17
      at Object.<anonymous> (src/__tests__/middleware/quota.test.ts:387:7)

    console.error
      [QuotaEnforcement] Unexpected error: Error: Unexpected error
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\middleware\quota.test.ts:399:65)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 174 |[39m       next()[33m;[39m
     [90m 175 |[39m     } [36mcatch[39m (error[33m:[39m any) {
    [31m[1m>[22m[39m[90m 176 |[39m       console[33m.[39merror([32m'[QuotaEnforcement] Unexpected error:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 177 |[39m       [36mreturn[39m res[33m.[39mstatus([35m500[39m)[33m.[39mjson({
     [90m 178 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 179 |[39m         error[33m:[39m [32m'Quota enforcement failed'[39m[33m,[39m[0m

      at src/middleware/quota.ts:176:15
      at Object.<anonymous> (src/__tests__/middleware/quota.test.ts:402:7)

    console.warn
      [QuotaEnforcement] Quota exceeded for org 1, dimension sites { current: undefined, limit: undefined, tier: 'pro' }

    [0m [90m 141 |[39m       [36mif[39m ([33m![39mresult[33m.[39mdata[33m?[39m[33m.[39mallowed) {
     [90m 142 |[39m         [90m// Quota exceeded - log event[39m
    [31m[1m>[22m[39m[90m 143 |[39m         console[33m.[39mwarn([32m`[QuotaEnforcement] Quota exceeded for org ${organizationId}, dimension ${dimension}`[39m[33m,[39m {
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 144 |[39m           current[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mcurrent[33m,[39m
     [90m 145 |[39m           limit[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mlimit[33m,[39m
     [90m 146 |[39m           tier[33m:[39m tier[33m.[39mplanTier[33m,[39m[0m

      at src/middleware/quota.ts:143:17
      at Object.<anonymous> (src/__tests__/middleware/quota.test.ts:431:7)

    console.warn
      [QuotaEnforcement] Quota exceeded for org 1, dimension posts { current: undefined, limit: undefined, tier: 'pro' }

    [0m [90m 141 |[39m       [36mif[39m ([33m![39mresult[33m.[39mdata[33m?[39m[33m.[39mallowed) {
     [90m 142 |[39m         [90m// Quota exceeded - log event[39m
    [31m[1m>[22m[39m[90m 143 |[39m         console[33m.[39mwarn([32m`[QuotaEnforcement] Quota exceeded for org ${organizationId}, dimension ${dimension}`[39m[33m,[39m {
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 144 |[39m           current[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mcurrent[33m,[39m
     [90m 145 |[39m           limit[33m:[39m result[33m.[39mdata[33m?[39m[33m.[39mlimit[33m,[39m
     [90m 146 |[39m           tier[33m:[39m tier[33m.[39mplanTier[33m,[39m[0m

      at src/middleware/quota.ts:143:17
      at Object.<anonymous> (src/__tests__/middleware/quota.test.ts:454:7)

PASS src/__tests__/config/stripe.test.ts
PASS src/__tests__/services/MemberService.test.ts
PASS src/__tests__/services/OrganizationService.test.ts
PASS src/__tests__/services/OrganizationService.cache.test.ts
PASS src/__tests__/routes/auth.test.ts (7.712 s)
PASS src/__tests__/middleware/rbac.test.ts
  ‚óè Console

    console.error
      [RBAC] Error checking permission: Error: Database connection failed
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\middleware\rbac.test.ts:113:9)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 231 |[39m     [36mreturn[39m hasAccess[33m;[39m
     [90m 232 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 233 |[39m     console[33m.[39merror([32m'[RBAC] Error checking permission:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 234 |[39m     [36mreturn[39m [36mfalse[39m[33m;[39m
     [90m 235 |[39m   }
     [90m 236 |[39m }[0m

      at checkPermission (src/middleware/rbac.ts:233:13)
      at Object.<anonymous> (src/__tests__/middleware/rbac.test.ts:116:22)

    console.error
      [RBAC] Error checking permission: Error: Database error
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\middleware\rbac.test.ts:268:9)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 231 |[39m     [36mreturn[39m hasAccess[33m;[39m
     [90m 232 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 233 |[39m     console[33m.[39merror([32m'[RBAC] Error checking permission:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 234 |[39m     [36mreturn[39m [36mfalse[39m[33m;[39m
     [90m 235 |[39m   }
     [90m 236 |[39m }[0m

      at checkPermission (src/middleware/rbac.ts:233:13)
      at src/middleware/rbac.ts:273:25
      at Object.<anonymous> (src/__tests__/middleware/rbac.test.ts:272:7)

PASS src/__tests__/services/siteService.test.ts
PASS src/__tests__/middleware/siteResolver.test.ts
PASS src/__tests__/types/versioning/guards.test.ts
PASS src/__tests__/config/permissions.test.ts
PASS src/__tests__/utils/jwt.test.ts
PASS src/__tests__/utils/slug.test.ts
PASS src/__tests__/middleware/auth.test.ts
PASS src/__tests__/routes/webhooks.test.ts
  ‚óè Console

    console.error
      SECURITY: Webhook signature verification failed: {"type":"webhook_signature_failed","ip":"::ffff:127.0.0.1","timestamp":"2025-11-23T10:45:09.773Z","error":"Invalid signature"}

    [0m [90m 130 |[39m       error[33m:[39m err[33m.[39mmessage[33m,[39m
     [90m 131 |[39m     }[33m;[39m
    [31m[1m>[22m[39m[90m 132 |[39m     console[33m.[39merror([32m'SECURITY: Webhook signature verification failed:'[39m[33m,[39m [33mJSON[39m[33m.[39mstringify(securityEvent))[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 133 |[39m
     [90m 134 |[39m     [90m// TODO: Send to security monitoring system (e.g., Sentry, DataDog)[39m
     [90m 135 |[39m     [90m// await securityMonitor.logEvent(securityEvent);[39m[0m

      at src/routes/webhooks.ts:132:13
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

    console.log
      Event evt_test123 already processed (quick check), skipping

      at src/routes/webhooks.ts:150:15

    console.log
      Event evt_concurrent is being processed by another request, skipping

      at src/routes/webhooks.ts:205:17

    console.log
      Event evt_test_retry exists but not processed, retrying

      at src/routes/webhooks.ts:222:17

    console.log
      Checkout completed for org 1, subscription sub_test456

      at handleCheckoutCompleted (src/routes/webhooks.ts:454:13)

    console.log
      Checkout completed for org 1, subscription sub_test123

      at handleCheckoutCompleted (src/routes/webhooks.ts:454:13)

    console.log
      Subscription upserted: sub_test_new, status: active

      at handleSubscriptionUpdated (src/routes/webhooks.ts:561:15)

    console.log
      Subscription updated: sub_test123, status: active

      at handleSubscriptionUpdated (src/routes/webhooks.ts:600:15)

    console.log
      Subscription deleted: sub_test123

      at handleSubscriptionDeleted (src/routes/webhooks.ts:679:13)

    console.error
      Error processing webhook event: TypeError: Cannot read properties of undefined (reading 'length')
          at handleInvoicePaid (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\webhooks.ts:727:17)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at handleWebhookEvent (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\webhooks.ts:312:7)
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\webhooks.ts:229:7

    [0m [90m 247 |[39m     }
     [90m 248 |[39m   } [36mcatch[39m (error[33m:[39m any) {
    [31m[1m>[22m[39m[90m 249 |[39m     console[33m.[39merror([32m'Error processing webhook event:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 250 |[39m
     [90m 251 |[39m     [90m// Determine if error is transient (should retry) or permanent (should not retry)[39m
     [90m 252 |[39m     [36mconst[39m isRetryable [33m=[39m isTransientError(error)[33m;[39m[0m

      at src/routes/webhooks.ts:249:13

    console.error
      Error processing webhook event: TypeError: Cannot read properties of undefined (reading 'length')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\webhooks.ts:203:24
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 247 |[39m     }
     [90m 248 |[39m   } [36mcatch[39m (error[33m:[39m any) {
    [31m[1m>[22m[39m[90m 249 |[39m     console[33m.[39merror([32m'Error processing webhook event:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 250 |[39m
     [90m 251 |[39m     [90m// Determine if error is transient (should retry) or permanent (should not retry)[39m
     [90m 252 |[39m     [36mconst[39m isRetryable [33m=[39m isTransientError(error)[33m;[39m[0m

      at src/routes/webhooks.ts:249:13

    console.error
      Error processing webhook event: TypeError: Cannot read properties of undefined (reading 'length')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\webhooks.ts:203:24
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 247 |[39m     }
     [90m 248 |[39m   } [36mcatch[39m (error[33m:[39m any) {
    [31m[1m>[22m[39m[90m 249 |[39m     console[33m.[39merror([32m'Error processing webhook event:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 250 |[39m
     [90m 251 |[39m     [90m// Determine if error is transient (should retry) or permanent (should not retry)[39m
     [90m 252 |[39m     [36mconst[39m isRetryable [33m=[39m isTransientError(error)[33m;[39m[0m

      at src/routes/webhooks.ts:249:13

    console.error
      Error processing webhook event: TypeError: Cannot read properties of undefined (reading 'length')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\webhooks.ts:203:24
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 247 |[39m     }
     [90m 248 |[39m   } [36mcatch[39m (error[33m:[39m any) {
    [31m[1m>[22m[39m[90m 249 |[39m     console[33m.[39merror([32m'Error processing webhook event:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 250 |[39m
     [90m 251 |[39m     [90m// Determine if error is transient (should retry) or permanent (should not retry)[39m
     [90m 252 |[39m     [36mconst[39m isRetryable [33m=[39m isTransientError(error)[33m;[39m[0m

      at src/routes/webhooks.ts:249:13

FAIL src/__tests__/services/VersionService.test.ts (8.311 s)
  ‚óè Console

    console.error
      Error validating site access: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.validateSiteAccess (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:669:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:91:28)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.test.ts:95:22)

    [0m [90m 676 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 677 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 678 |[39m       console[33m.[39merror([32m'Error validating site access:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 679 |[39m       [36mreturn[39m {
     [90m 680 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 681 |[39m         error[33m:[39m [32m'Failed to validate site access'[39m[0m

      at VersionService.validateSiteAccess (src/services/VersionService.ts:678:15)
      at VersionService.createVersion (src/services/VersionService.ts:91:28)
      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:95:22)

    console.error
      Error validating site access: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.validateSiteAccess (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:669:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:91:28)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.test.ts:118:22)

    [0m [90m 676 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 677 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 678 |[39m       console[33m.[39merror([32m'Error validating site access:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 679 |[39m       [36mreturn[39m {
     [90m 680 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 681 |[39m         error[33m:[39m [32m'Failed to validate site access'[39m[0m

      at VersionService.validateSiteAccess (src/services/VersionService.ts:678:15)
      at VersionService.createVersion (src/services/VersionService.ts:91:28)
      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:118:22)

    console.error
      Error validating site access: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.validateSiteAccess (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:669:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:91:28)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.test.ts:155:22)

    [0m [90m 676 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 677 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 678 |[39m       console[33m.[39merror([32m'Error validating site access:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 679 |[39m       [36mreturn[39m {
     [90m 680 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 681 |[39m         error[33m:[39m [32m'Failed to validate site access'[39m[0m

      at VersionService.validateSiteAccess (src/services/VersionService.ts:678:15)
      at VersionService.createVersion (src/services/VersionService.ts:91:28)
      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:155:22)

    console.error
      Error publishing version: Error: Version not found
          at VersionService.publishVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:373:15)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.test.ts:285:22)

    [0m [90m 438 |[39m     } [36mcatch[39m (error) {
     [90m 439 |[39m       [36mawait[39m client[33m.[39mquery([32m'ROLLBACK'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 440 |[39m       console[33m.[39merror([32m'Error publishing version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 441 |[39m       [36mreturn[39m {
     [90m 442 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 443 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to publish version'[39m[0m

      at VersionService.publishVersion (src/services/VersionService.ts:440:15)
      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:285:22)

    console.error
      Error publishing version: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.publishVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:372:25)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.test.ts:297:22)

    [0m [90m 438 |[39m     } [36mcatch[39m (error) {
     [90m 439 |[39m       [36mawait[39m client[33m.[39mquery([32m'ROLLBACK'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 440 |[39m       console[33m.[39merror([32m'Error publishing version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 441 |[39m       [36mreturn[39m {
     [90m 442 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 443 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to publish version'[39m[0m

      at VersionService.publishVersion (src/services/VersionService.ts:440:15)
      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:297:22)

    console.error
      Error getting version count: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.getVersionCount (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:735:30)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:103:26)
          at VersionService.revertToVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:482:26)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.test.ts:351:22)

    [0m [90m 735 |[39m       [36mreturn[39m parseInt(result[33m.[39mrows[[35m0[39m][33m.[39mcount)[33m;[39m
     [90m 736 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 737 |[39m       console[33m.[39merror([32m'Error getting version count:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 738 |[39m       [36mreturn[39m [35m0[39m[33m;[39m
     [90m 739 |[39m     }
     [90m 740 |[39m   }[0m

      at VersionService.getVersionCount (src/services/VersionService.ts:737:15)
      at VersionService.createVersion (src/services/VersionService.ts:103:26)
      at VersionService.revertToVersion (src/services/VersionService.ts:482:26)
      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:351:22)

    console.error
      Error creating version: TypeError: Cannot read properties of undefined (reading 'version_number')
          at VersionService.createVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:123:57)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at VersionService.revertToVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:482:26)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.test.ts:351:22)

    [0m [90m 216 |[39m     } [36mcatch[39m (error) {
     [90m 217 |[39m       [36mawait[39m client[33m.[39mquery([32m'ROLLBACK'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 218 |[39m       console[33m.[39merror([32m'Error creating version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 219 |[39m       [36mreturn[39m {
     [90m 220 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 221 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to create version'[39m[0m

      at VersionService.createVersion (src/services/VersionService.ts:218:15)
      at VersionService.revertToVersion (src/services/VersionService.ts:482:26)
      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:351:22)

    console.error
      Error fetching version: TypeError: Cannot read properties of undefined (reading 'rows')
          at VersionService.getVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:241:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at async Promise.all (index 1)
          at VersionService.compareVersions (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\VersionService.ts:548:36)
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\services\VersionService.test.ts:435:22)

    [0m [90m 251 |[39m       }[33m;[39m
     [90m 252 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 253 |[39m       console[33m.[39merror([32m'Error fetching version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 254 |[39m       [36mreturn[39m {
     [90m 255 |[39m         success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 256 |[39m         error[33m:[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Failed to fetch version'[39m[0m

      at VersionService.getVersion (src/services/VersionService.ts:253:15)
          at async Promise.all (index 1)
      at VersionService.compareVersions (src/services/VersionService.ts:548:36)
      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:435:22)

  ‚óè VersionService ‚Ä∫ createVersion ‚Ä∫ should create a new version successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m  95 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mcreateVersion(input[33m,[39m [35m1[39m)[33m;[39m
     [90m  96 |[39m
    [31m[1m>[22m[39m[90m  97 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m  98 |[39m       expect(result[33m.[39mdata)[33m.[39mtoEqual(mockVersion)[33m;[39m
     [90m  99 |[39m       expect(mockClient[33m.[39mquery)[33m.[39mtoHaveBeenCalledWith([32m'BEGIN'[39m)[33m;[39m
     [90m 100 |[39m       expect(mockClient[33m.[39mquery)[33m.[39mtoHaveBeenCalledWith([32m'COMMIT'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:97:30)

  ‚óè VersionService ‚Ä∫ createVersion ‚Ä∫ should rollback on error

    expect(received).toBe(expected) // Object.is equality

    Expected: "Database error"
    Received: "Failed to validate site access"

    [0m [90m 119 |[39m
     [90m 120 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 121 |[39m       expect(result[33m.[39merror)[33m.[39mtoBe([32m'Database error'[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 122 |[39m       expect(mockClient[33m.[39mquery)[33m.[39mtoHaveBeenCalledWith([32m'ROLLBACK'[39m)[33m;[39m
     [90m 123 |[39m       expect(mockClient[33m.[39mrelease)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m 124 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:121:28)

  ‚óè VersionService ‚Ä∫ createVersion ‚Ä∫ should detect changed fields correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 155 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mcreateVersion(input[33m,[39m [35m1[39m)[33m;[39m
     [90m 156 |[39m
    [31m[1m>[22m[39m[90m 157 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 158 |[39m       expect(result[33m.[39mmetadata[33m?[39m[33m.[39mversion_number)[33m.[39mtoBe([35m2[39m)[33m;[39m
     [90m 159 |[39m     })[33m;[39m
     [90m 160 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:157:30)

  ‚óè VersionService ‚Ä∫ publishVersion ‚Ä∫ should publish a version successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 285 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mpublishVersion([35m1[39m[33m,[39m [35m1[39m)[33m;[39m
     [90m 286 |[39m
    [31m[1m>[22m[39m[90m 287 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 288 |[39m       expect(mockClient[33m.[39mquery)[33m.[39mtoHaveBeenCalledWith([32m'BEGIN'[39m)[33m;[39m
     [90m 289 |[39m       expect(mockClient[33m.[39mquery)[33m.[39mtoHaveBeenCalledWith([32m'COMMIT'[39m)[33m;[39m
     [90m 290 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:287:30)

  ‚óè VersionService ‚Ä∫ publishVersion ‚Ä∫ should handle version not found

    expect(received).toBe(expected) // Object.is equality

    Expected: "Version not found"
    Received: "Cannot read properties of undefined (reading 'rows')"

    [0m [90m 298 |[39m
     [90m 299 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 300 |[39m       expect(result[33m.[39merror)[33m.[39mtoBe([32m'Version not found'[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 301 |[39m       expect(mockClient[33m.[39mquery)[33m.[39mtoHaveBeenCalledWith([32m'ROLLBACK'[39m)[33m;[39m
     [90m 302 |[39m     })[33m;[39m
     [90m 303 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:300:28)

  ‚óè VersionService ‚Ä∫ revertToVersion ‚Ä∫ should revert to a previous version

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 351 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mrevertToVersion([35m1[39m[33m,[39m [35m1[39m)[33m;[39m
     [90m 352 |[39m
    [31m[1m>[22m[39m[90m 353 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 354 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mversion_number)[33m.[39mtoBe([35m3[39m)[33m;[39m
     [90m 355 |[39m     })[33m;[39m
     [90m 356 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:353:30)

PASS src/__tests__/services/DiffService.test.ts (8.492 s)
FAIL src/__tests__/integration/cv007-diff.integration.test.ts (8.695 s)
  ‚óè Console

    console.error
      Error fetching version: TypeError: Cannot read properties of undefined (reading 'rows')
          at DiffService.fetchVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\DiffService.ts:858:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at DiffService.compareVersions (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\DiffService.ts:180:30)
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\versions.ts:176:24

    [0m [90m 862 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m result[33m.[39mrows[[35m0[39m] }[33m;[39m
     [90m 863 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 864 |[39m       console[33m.[39merror([32m'Error fetching version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 865 |[39m       [36mreturn[39m { success[33m:[39m [36mfalse[39m[33m,[39m error[33m:[39m [32m'Failed to fetch version'[39m }[33m;[39m
     [90m 866 |[39m     }
     [90m 867 |[39m   }[0m

      at DiffService.fetchVersion (src/services/DiffService.ts:864:15)
      at DiffService.compareVersions (src/services/DiffService.ts:180:30)
      at src/routes/versions.ts:176:24

    console.error
      Error fetching version: TypeError: Cannot read properties of undefined (reading 'rows')
          at DiffService.fetchVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\DiffService.ts:858:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at DiffService.compareVersions (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\DiffService.ts:181:30)
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\versions.ts:176:24

    [0m [90m 862 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m result[33m.[39mrows[[35m0[39m] }[33m;[39m
     [90m 863 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 864 |[39m       console[33m.[39merror([32m'Error fetching version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 865 |[39m       [36mreturn[39m { success[33m:[39m [36mfalse[39m[33m,[39m error[33m:[39m [32m'Failed to fetch version'[39m }[33m;[39m
     [90m 866 |[39m     }
     [90m 867 |[39m   }[0m

      at DiffService.fetchVersion (src/services/DiffService.ts:864:15)
      at DiffService.compareVersions (src/services/DiffService.ts:181:30)
      at src/routes/versions.ts:176:24

    console.error
      Error fetching version: TypeError: Cannot read properties of undefined (reading 'rows')
          at DiffService.fetchVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\DiffService.ts:858:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at DiffService.compareVersions (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\DiffService.ts:180:30)
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\versions.ts:261:28

    [0m [90m 862 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m result[33m.[39mrows[[35m0[39m] }[33m;[39m
     [90m 863 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 864 |[39m       console[33m.[39merror([32m'Error fetching version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 865 |[39m       [36mreturn[39m { success[33m:[39m [36mfalse[39m[33m,[39m error[33m:[39m [32m'Failed to fetch version'[39m }[33m;[39m
     [90m 866 |[39m     }
     [90m 867 |[39m   }[0m

      at DiffService.fetchVersion (src/services/DiffService.ts:864:15)
      at DiffService.compareVersions (src/services/DiffService.ts:180:30)
      at src/routes/versions.ts:261:28

    console.error
      Error fetching version: TypeError: Cannot read properties of undefined (reading 'rows')
          at DiffService.fetchVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\DiffService.ts:858:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at DiffService.compareVersions (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\DiffService.ts:181:30)
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\versions.ts:261:28

    [0m [90m 862 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m result[33m.[39mrows[[35m0[39m] }[33m;[39m
     [90m 863 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 864 |[39m       console[33m.[39merror([32m'Error fetching version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 865 |[39m       [36mreturn[39m { success[33m:[39m [36mfalse[39m[33m,[39m error[33m:[39m [32m'Failed to fetch version'[39m }[33m;[39m
     [90m 866 |[39m     }
     [90m 867 |[39m   }[0m

      at DiffService.fetchVersion (src/services/DiffService.ts:864:15)
      at DiffService.compareVersions (src/services/DiffService.ts:181:30)
      at src/routes/versions.ts:261:28

    console.error
      Error fetching version: TypeError: Cannot read properties of undefined (reading 'rows')
          at DiffService.fetchVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\DiffService.ts:858:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at DiffService.compareVersions (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\DiffService.ts:180:30)
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\versions.ts:261:28

    [0m [90m 862 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m result[33m.[39mrows[[35m0[39m] }[33m;[39m
     [90m 863 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 864 |[39m       console[33m.[39merror([32m'Error fetching version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 865 |[39m       [36mreturn[39m { success[33m:[39m [36mfalse[39m[33m,[39m error[33m:[39m [32m'Failed to fetch version'[39m }[33m;[39m
     [90m 866 |[39m     }
     [90m 867 |[39m   }[0m

      at DiffService.fetchVersion (src/services/DiffService.ts:864:15)
      at DiffService.compareVersions (src/services/DiffService.ts:180:30)
      at src/routes/versions.ts:261:28

    console.error
      Error fetching version: TypeError: Cannot read properties of undefined (reading 'rows')
          at DiffService.fetchVersion (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\DiffService.ts:858:18)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at DiffService.compareVersions (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\services\DiffService.ts:181:30)
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\versions.ts:261:28

    [0m [90m 862 |[39m       [36mreturn[39m { success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m result[33m.[39mrows[[35m0[39m] }[33m;[39m
     [90m 863 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 864 |[39m       console[33m.[39merror([32m'Error fetching version:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 865 |[39m       [36mreturn[39m { success[33m:[39m [36mfalse[39m[33m,[39m error[33m:[39m [32m'Failed to fetch version'[39m }[33m;[39m
     [90m 866 |[39m     }
     [90m 867 |[39m   }[0m

      at DiffService.fetchVersion (src/services/DiffService.ts:864:15)
      at DiffService.compareVersions (src/services/DiffService.ts:181:30)
      at src/routes/versions.ts:261:28

    console.error
      Error getting changes summary: TypeError: Cannot read properties of undefined (reading 'rows')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\versions.ts:352:27
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 440 |[39m         })[33m;[39m
     [90m 441 |[39m       } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 442 |[39m         console[33m.[39merror([32m'Error getting changes summary:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 443 |[39m         res[33m.[39mstatus([35m500[39m)[33m.[39mjson({
     [90m 444 |[39m           success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 445 |[39m           error[33m:[39m [32m'Internal server error'[39m[0m

      at src/routes/versions.ts:442:17

    console.error
      Error getting version history: TypeError: Cannot read properties of undefined (reading 'rows')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\versions.ts:473:28
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 535 |[39m         })[33m;[39m
     [90m 536 |[39m       } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 537 |[39m         console[33m.[39merror([32m'Error getting version history:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 538 |[39m         res[33m.[39mstatus([35m500[39m)[33m.[39mjson({
     [90m 539 |[39m           success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 540 |[39m           error[33m:[39m [32m'Internal server error'[39m[0m

      at src/routes/versions.ts:537:17

    console.error
      Error getting version history: TypeError: Cannot read properties of undefined (reading 'rows')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\versions.ts:473:28
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 535 |[39m         })[33m;[39m
     [90m 536 |[39m       } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 537 |[39m         console[33m.[39merror([32m'Error getting version history:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 538 |[39m         res[33m.[39mstatus([35m500[39m)[33m.[39mjson({
     [90m 539 |[39m           success[33m:[39m [36mfalse[39m[33m,[39m
     [90m 540 |[39m           error[33m:[39m [32m'Internal server error'[39m[0m

      at src/routes/versions.ts:537:17

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ GET /api/versions/compare ‚Ä∫ should enforce site isolation

    expected 400 "Bad Request", got 200 "OK"

    [0m [90m 118 |[39m           version_b_id[33m:[39m [35m2[39m
     [90m 119 |[39m         })
    [31m[1m>[22m[39m[90m 120 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 121 |[39m
     [90m 122 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 123 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'site isolation'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:120:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ GET /api/versions/compare ‚Ä∫ should validate user access

    expected 400 "Bad Request", got 200 "OK"

    [0m [90m 138 |[39m           version_b_id[33m:[39m [35m2[39m
     [90m 139 |[39m         })
    [31m[1m>[22m[39m[90m 140 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 141 |[39m
     [90m 142 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 143 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Access denied'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:140:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ GET /api/versions/:id1/diff/:id2 ‚Ä∫ should get diff between two versions

    expected 200 "OK", got 400 "Bad Request"

    [0m [90m 174 |[39m         [33m.[39m[36mget[39m([32m'/api/versions/1/diff/2'[39m)
     [90m 175 |[39m         [33m.[39mquery({ format[33m:[39m [32m'json'[39m })
    [31m[1m>[22m[39m[90m 176 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 177 |[39m
     [90m 178 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 179 |[39m       expect(response[33m.[39mbody[33m.[39mdata)[33m.[39mtoBeDefined()[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:176:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ POST /api/versions/diff/export ‚Ä∫ should export diff as JSON

    expected 200 "OK", got 400 "Bad Request"

    [0m [90m 217 |[39m           include_statistics[33m:[39m [36mtrue[39m
     [90m 218 |[39m         })
    [31m[1m>[22m[39m[90m 219 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 220 |[39m
     [90m 221 |[39m       [90m// Response should be JSON export[39m
     [90m 222 |[39m       [36mconst[39m exportData [33m=[39m [33mJSON[39m[33m.[39mparse(response[33m.[39mtext)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:219:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ POST /api/versions/diff/export ‚Ä∫ should export diff as HTML

    expected 200 "OK", got 400 "Bad Request"

    [0m [90m 257 |[39m           include_metadata[33m:[39m [36mtrue[39m
     [90m 258 |[39m         })
    [31m[1m>[22m[39m[90m 259 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 260 |[39m
     [90m 261 |[39m       [90m// Response should be HTML[39m
     [90m 262 |[39m       expect(response[33m.[39mtext)[33m.[39mtoContain([32m'<!DOCTYPE html>'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:259:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ GET /api/versions/:id/changes-summary ‚Ä∫ should get changes summary for a version

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 299 |[39m         [33m.[39m[36mget[39m([32m'/api/versions/2/changes-summary'[39m)
     [90m 300 |[39m         [33m.[39mquery({ compare_with[33m:[39m [32m'previous'[39m })
    [31m[1m>[22m[39m[90m 301 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 302 |[39m
     [90m 303 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 304 |[39m       expect(response[33m.[39mbody[33m.[39mdata)[33m.[39mtoBeDefined()[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:301:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ GET /api/versions/history/:contentType/:contentId ‚Ä∫ should get version history with diff summaries

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 368 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 369 |[39m         [33m.[39m[36mget[39m([32m'/api/versions/history/post/1'[39m)
    [31m[1m>[22m[39m[90m 370 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 371 |[39m
     [90m 372 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 373 |[39m       expect(response[33m.[39mbody[33m.[39mdata)[33m.[39mtoBeDefined()[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:370:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ GET /api/versions/history/:contentType/:contentId ‚Ä∫ should return 404 when no versions found

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 386 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 387 |[39m         [33m.[39m[36mget[39m([32m'/api/versions/history/post/999'[39m)
    [31m[1m>[22m[39m[90m 388 |[39m         [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 389 |[39m
     [90m 390 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 391 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'No versions found'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:388:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

PASS src/__tests__/routes/auth.signup.test.ts (8.749 s)
FAIL src/__tests__/routes/autosave.test.ts (9.087 s)
  ‚óè Console

    console.error
      Error creating auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:67:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 85 |[39m       })[33m;[39m
     [90m 86 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 87 |[39m       console[33m.[39merror([32m'Error creating auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 88 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 89 |[39m     }
     [90m 90 |[39m   }[0m

      at src/routes/autosave.ts:87:15

    console.error
      Error creating auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:67:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 85 |[39m       })[33m;[39m
     [90m 86 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 87 |[39m       console[33m.[39merror([32m'Error creating auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 88 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 89 |[39m     }
     [90m 90 |[39m   }[0m

      at src/routes/autosave.ts:87:15

    console.error
      Error creating auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:67:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 85 |[39m       })[33m;[39m
     [90m 86 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 87 |[39m       console[33m.[39merror([32m'Error creating auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 88 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 89 |[39m     }
     [90m 90 |[39m   }[0m

      at src/routes/autosave.ts:87:15

    console.error
      Error creating auto-save: Error: Unexpected database error
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\routes\autosave.test.ts:211:47)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 85 |[39m       })[33m;[39m
     [90m 86 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 87 |[39m       console[33m.[39merror([32m'Error creating auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 88 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 89 |[39m     }
     [90m 90 |[39m   }[0m

      at src/routes/autosave.ts:87:15

    console.error
      Error creating auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:67:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 85 |[39m       })[33m;[39m
     [90m 86 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 87 |[39m       console[33m.[39merror([32m'Error creating auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 88 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 89 |[39m     }
     [90m 90 |[39m   }[0m

      at src/routes/autosave.ts:87:15

    console.error
      Error creating auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:67:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 85 |[39m       })[33m;[39m
     [90m 86 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 87 |[39m       console[33m.[39merror([32m'Error creating auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 88 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 89 |[39m     }
     [90m 90 |[39m   }[0m

      at src/routes/autosave.ts:87:15

    console.error
      Error creating auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:67:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 85 |[39m       })[33m;[39m
     [90m 86 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 87 |[39m       console[33m.[39merror([32m'Error creating auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 88 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 89 |[39m     }
     [90m 90 |[39m   }[0m

      at src/routes/autosave.ts:87:15

    console.error
      Error getting latest auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:120:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 147 |[39m       })[33m;[39m
     [90m 148 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 149 |[39m       console[33m.[39merror([32m'Error getting latest auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 150 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 151 |[39m     }
     [90m 152 |[39m   }[0m

      at src/routes/autosave.ts:149:15

    console.error
      Error getting latest auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:120:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 147 |[39m       })[33m;[39m
     [90m 148 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 149 |[39m       console[33m.[39merror([32m'Error getting latest auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 150 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 151 |[39m     }
     [90m 152 |[39m   }[0m

      at src/routes/autosave.ts:149:15

    console.error
      Error getting latest auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:120:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 147 |[39m       })[33m;[39m
     [90m 148 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 149 |[39m       console[33m.[39merror([32m'Error getting latest auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 150 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 151 |[39m     }
     [90m 152 |[39m   }[0m

      at src/routes/autosave.ts:149:15

    console.error
      Error getting latest auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:120:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 147 |[39m       })[33m;[39m
     [90m 148 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 149 |[39m       console[33m.[39merror([32m'Error getting latest auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 150 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 151 |[39m     }
     [90m 152 |[39m   }[0m

      at src/routes/autosave.ts:149:15

    console.error
      Error checking auto-save status: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:188:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 211 |[39m       })[33m;[39m
     [90m 212 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 213 |[39m       console[33m.[39merror([32m'Error checking auto-save status:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 214 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 215 |[39m     }
     [90m 216 |[39m   }[0m

      at src/routes/autosave.ts:213:15

    console.error
      Error checking auto-save status: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:188:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 211 |[39m       })[33m;[39m
     [90m 212 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 213 |[39m       console[33m.[39merror([32m'Error checking auto-save status:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 214 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 215 |[39m     }
     [90m 216 |[39m   }[0m

      at src/routes/autosave.ts:213:15

    console.error
      Error checking auto-save status: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:188:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 211 |[39m       })[33m;[39m
     [90m 212 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 213 |[39m       console[33m.[39merror([32m'Error checking auto-save status:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 214 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 215 |[39m     }
     [90m 216 |[39m   }[0m

      at src/routes/autosave.ts:213:15

    console.error
      Error cleaning up auto-saves: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:247:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 254 |[39m       })[33m;[39m
     [90m 255 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 256 |[39m       console[33m.[39merror([32m'Error cleaning up auto-saves:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 257 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 258 |[39m     }
     [90m 259 |[39m   }[0m

      at src/routes/autosave.ts:256:15

    console.error
      Error cleaning up auto-saves: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:247:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 254 |[39m       })[33m;[39m
     [90m 255 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 256 |[39m       console[33m.[39merror([32m'Error cleaning up auto-saves:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 257 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 258 |[39m     }
     [90m 259 |[39m   }[0m

      at src/routes/autosave.ts:256:15

    console.error
      Error cleaning up auto-saves: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:247:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 254 |[39m       })[33m;[39m
     [90m 255 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 256 |[39m       console[33m.[39merror([32m'Error cleaning up auto-saves:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 257 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 258 |[39m     }
     [90m 259 |[39m   }[0m

      at src/routes/autosave.ts:256:15

    console.error
      Error cleaning up auto-saves: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:247:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 254 |[39m       })[33m;[39m
     [90m 255 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 256 |[39m       console[33m.[39merror([32m'Error cleaning up auto-saves:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 257 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 258 |[39m     }
     [90m 259 |[39m   }[0m

      at src/routes/autosave.ts:256:15

    console.error
      Error creating auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:67:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 85 |[39m       })[33m;[39m
     [90m 86 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 87 |[39m       console[33m.[39merror([32m'Error creating auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 88 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 89 |[39m     }
     [90m 90 |[39m   }[0m

      at src/routes/autosave.ts:87:15

    console.error
      Error cleaning up auto-saves: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:247:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 254 |[39m       })[33m;[39m
     [90m 255 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 256 |[39m       console[33m.[39merror([32m'Error cleaning up auto-saves:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 257 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 258 |[39m     }
     [90m 259 |[39m   }[0m

      at src/routes/autosave.ts:256:15

    console.error
      Error creating auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:67:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 85 |[39m       })[33m;[39m
     [90m 86 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 87 |[39m       console[33m.[39merror([32m'Error creating auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 88 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 89 |[39m     }
     [90m 90 |[39m   }[0m

      at src/routes/autosave.ts:87:15

    console.error
      Error creating auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:67:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 85 |[39m       })[33m;[39m
     [90m 86 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 87 |[39m       console[33m.[39merror([32m'Error creating auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 88 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 89 |[39m     }
     [90m 90 |[39m   }[0m

      at src/routes/autosave.ts:87:15

    console.error
      Error creating auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:67:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 85 |[39m       })[33m;[39m
     [90m 86 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 87 |[39m       console[33m.[39merror([32m'Error creating auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 88 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 89 |[39m     }
     [90m 90 |[39m   }[0m

      at src/routes/autosave.ts:87:15

    console.error
      Error creating auto-save: TypeError: Cannot read properties of undefined (reading 'success')
          at C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\routes\autosave.ts:67:19
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 85 |[39m       })[33m;[39m
     [90m 86 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 87 |[39m       console[33m.[39merror([32m'Error creating auto-save:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 88 |[39m       res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Internal server error'[39m })[33m;[39m
     [90m 89 |[39m     }
     [90m 90 |[39m   }[0m

      at src/routes/autosave.ts:87:15

  ‚óè Auto-Save API Routes ‚Ä∫ POST /api/content/:contentType/:contentId/autosave ‚Ä∫ should create auto-save successfully

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 146 |[39m         [33m.[39mpost([32m'/api/content/post/1/autosave'[39m)
     [90m 147 |[39m         [33m.[39msend(validAutoSaveData)
    [31m[1m>[22m[39m[90m 148 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 149 |[39m
     [90m 150 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 151 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mversion)[33m.[39mtoEqual(mockAutoSaveResult[33m.[39mdata)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:148:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ POST /api/content/:contentType/:contentId/autosave ‚Ä∫ should handle no changes detected gracefully

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 176 |[39m         [33m.[39mpost([32m'/api/content/post/1/autosave'[39m)
     [90m 177 |[39m         [33m.[39msend(validAutoSaveData)
    [31m[1m>[22m[39m[90m 178 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 179 |[39m
     [90m 180 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 181 |[39m       expect(response[33m.[39mbody[33m.[39mdata)[33m.[39mtoBeNull()[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:178:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ POST /api/content/:contentType/:contentId/autosave ‚Ä∫ should handle VersionService errors

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 203 |[39m         [33m.[39mpost([32m'/api/content/post/1/autosave'[39m)
     [90m 204 |[39m         [33m.[39msend(validAutoSaveData)
    [31m[1m>[22m[39m[90m 205 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 206 |[39m
     [90m 207 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoBe([32m'Database connection failed'[39m)[33m;[39m
     [90m 208 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:205:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ POST /api/content/:contentType/:contentId/autosave ‚Ä∫ should generate content hash from request data

    TypeError: Cannot read properties of undefined (reading '0')

    [0m [90m 230 |[39m
     [90m 231 |[39m       [36mconst[39m createCall [33m=[39m mockVersionService[33m.[39mcreateAutoSave[33m.[39mmock[33m.[39mcalls[[35m0[39m][33m;[39m
    [31m[1m>[22m[39m[90m 232 |[39m       [36mconst[39m inputData [33m=[39m createCall[[35m0[39m][33m;[39m
     [90m     |[39m                                   [31m[1m^[22m[39m
     [90m 233 |[39m
     [90m 234 |[39m       expect(inputData[33m.[39mcontent_hash)[33m.[39mtoBeDefined()[33m;[39m
     [90m 235 |[39m       expect([36mtypeof[39m inputData[33m.[39mcontent_hash)[33m.[39mtoBe([32m'string'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:232:35)

  ‚óè Auto-Save API Routes ‚Ä∫ POST /api/content/:contentType/:contentId/autosave ‚Ä∫ should work with page content type

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 246 |[39m         [33m.[39mpost([32m'/api/content/page/1/autosave'[39m)
     [90m 247 |[39m         [33m.[39msend(validAutoSaveData)
    [31m[1m>[22m[39m[90m 248 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 249 |[39m
     [90m 250 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 251 |[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:248:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ POST /api/content/:contentType/:contentId/autosave ‚Ä∫ should use default site_id when not found

    TypeError: Cannot read properties of undefined (reading '0')

    [0m [90m 269 |[39m
     [90m 270 |[39m       [36mconst[39m createCall [33m=[39m mockVersionService[33m.[39mcreateAutoSave[33m.[39mmock[33m.[39mcalls[[35m0[39m][33m;[39m
    [31m[1m>[22m[39m[90m 271 |[39m       expect(createCall[[35m0[39m][33m.[39msite_id)[33m.[39mtoBe([35m1[39m)[33m;[39m [90m// Default site ID[39m
     [90m     |[39m                        [31m[1m^[22m[39m
     [90m 272 |[39m       expect(createCall[[35m2[39m])[33m.[39mtoBe([35m1[39m)[33m;[39m [90m// Site ID parameter[39m
     [90m 273 |[39m     })[33m;[39m
     [90m 274 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:271:24)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/latest ‚Ä∫ should retrieve latest auto-save successfully

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 304 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 305 |[39m         [33m.[39m[36mget[39m([32m'/api/content/post/1/autosave/latest'[39m)
    [31m[1m>[22m[39m[90m 306 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 307 |[39m
     [90m 308 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 309 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mversion)[33m.[39mtoEqual(mockAutoSave)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:306:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/latest ‚Ä∫ should detect newer manual save

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 337 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 338 |[39m         [33m.[39m[36mget[39m([32m'/api/content/post/1/autosave/latest'[39m)
    [31m[1m>[22m[39m[90m 339 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 340 |[39m
     [90m 341 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mhas_newer_manual_save)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 342 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:339:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/latest ‚Ä∫ should return null when no auto-save exists

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 354 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 355 |[39m         [33m.[39m[36mget[39m([32m'/api/content/post/1/autosave/latest'[39m)
    [31m[1m>[22m[39m[90m 356 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 357 |[39m
     [90m 358 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 359 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mversion)[33m.[39mtoBeNull()[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:356:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/latest ‚Ä∫ should handle VersionService errors

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 369 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 370 |[39m         [33m.[39m[36mget[39m([32m'/api/content/post/1/autosave/latest'[39m)
    [31m[1m>[22m[39m[90m 371 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 372 |[39m
     [90m 373 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoBe([32m'Database query failed'[39m)[33m;[39m
     [90m 374 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:371:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/latest ‚Ä∫ should return 404 for non-existent content

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 379 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 380 |[39m         [33m.[39m[36mget[39m([32m'/api/content/post/999/autosave/latest'[39m)
    [31m[1m>[22m[39m[90m 381 |[39m         [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 382 |[39m
     [90m 383 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoBe([32m'post not found'[39m)[33m;[39m
     [90m 384 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:381:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/status ‚Ä∫ should check unsaved changes status successfully

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 408 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 409 |[39m         [33m.[39m[36mget[39m([32m`/api/content/post/1/autosave/status?content_hash=${testContentHash}`[39m)
    [31m[1m>[22m[39m[90m 410 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 411 |[39m
     [90m 412 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 413 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mhas_unsaved_changes)[33m.[39mtoBe([36mtrue[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:410:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/status ‚Ä∫ should return false for no unsaved changes

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 436 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 437 |[39m         [33m.[39m[36mget[39m([32m`/api/content/post/1/autosave/status?content_hash=${testContentHash}`[39m)
    [31m[1m>[22m[39m[90m 438 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 439 |[39m
     [90m 440 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mhas_unsaved_changes)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 441 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:438:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/status ‚Ä∫ should handle no existing versions

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 461 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 462 |[39m         [33m.[39m[36mget[39m([32m`/api/content/post/1/autosave/status?content_hash=${testContentHash}`[39m)
    [31m[1m>[22m[39m[90m 463 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 464 |[39m
     [90m 465 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mlatest_version_number)[33m.[39mtoBe([35m0[39m)[33m;[39m
     [90m 466 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:463:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/status ‚Ä∫ should handle VersionService errors

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 474 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 475 |[39m         [33m.[39m[36mget[39m([32m`/api/content/post/1/autosave/status?content_hash=${testContentHash}`[39m)
    [31m[1m>[22m[39m[90m 476 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 477 |[39m
     [90m 478 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoBe([32m'Hash comparison failed'[39m)[33m;[39m
     [90m 479 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:476:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ DELETE /api/content/:contentType/:contentId/autosave/cleanup ‚Ä∫ should cleanup old auto-saves successfully

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 495 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 496 |[39m         [33m.[39m[36mdelete[39m([32m'/api/content/post/1/autosave/cleanup'[39m)
    [31m[1m>[22m[39m[90m 497 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 498 |[39m
     [90m 499 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 500 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoBe([32m'Cleaned up 3 old auto-saves'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:497:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ DELETE /api/content/:contentType/:contentId/autosave/cleanup ‚Ä∫ should handle zero deletions

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 515 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 516 |[39m         [33m.[39m[36mdelete[39m([32m'/api/content/post/1/autosave/cleanup'[39m)
    [31m[1m>[22m[39m[90m 517 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 518 |[39m
     [90m 519 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoBe([32m'Cleaned up 0 old auto-saves'[39m)[33m;[39m
     [90m 520 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:517:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ DELETE /api/content/:contentType/:contentId/autosave/cleanup ‚Ä∫ should handle missing deleted_count in response

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 528 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 529 |[39m         [33m.[39m[36mdelete[39m([32m'/api/content/post/1/autosave/cleanup'[39m)
    [31m[1m>[22m[39m[90m 530 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 531 |[39m
     [90m 532 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoBe([32m'Cleaned up 0 old auto-saves'[39m)[33m;[39m
     [90m 533 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:530:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ DELETE /api/content/:contentType/:contentId/autosave/cleanup ‚Ä∫ should handle VersionService errors

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 541 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 542 |[39m         [33m.[39m[36mdelete[39m([32m'/api/content/post/1/autosave/cleanup'[39m)
    [31m[1m>[22m[39m[90m 543 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 544 |[39m
     [90m 545 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoBe([32m'Cleanup operation failed'[39m)[33m;[39m
     [90m 546 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:543:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ DELETE /api/content/:contentType/:contentId/autosave/cleanup ‚Ä∫ should require content access permissions

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 569 |[39m       [36mawait[39m request(app)
     [90m 570 |[39m         [33m.[39m[36mdelete[39m([32m'/api/content/post/1/autosave/cleanup'[39m)
    [31m[1m>[22m[39m[90m 571 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 572 |[39m
     [90m 573 |[39m       [90m// Verify middleware was called[39m
     [90m 574 |[39m       expect(mockCheckContentAccess)[33m.[39mtoHaveBeenCalled()[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:571:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ Content Hash Generation ‚Ä∫ should generate deterministic hashes for same content

    TypeError: Cannot read properties of undefined (reading '0')

    [0m [90m 653 |[39m       [36mconst[39m call2 [33m=[39m mockVersionService[33m.[39mcreateAutoSave[33m.[39mmock[33m.[39mcalls[[35m1[39m][33m;[39m
     [90m 654 |[39m
    [31m[1m>[22m[39m[90m 655 |[39m       expect(call1[[35m0[39m][33m.[39mcontent_hash)[33m.[39mtoBe(call2[[35m0[39m][33m.[39mcontent_hash)[33m;[39m
     [90m     |[39m                   [31m[1m^[22m[39m
     [90m 656 |[39m     })[33m;[39m
     [90m 657 |[39m
     [90m 658 |[39m     it([32m'should generate different hashes for different content'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:655:19)

  ‚óè Auto-Save API Routes ‚Ä∫ Content Hash Generation ‚Ä∫ should generate different hashes for different content

    TypeError: Cannot read properties of undefined (reading '0')

    [0m [90m 676 |[39m       [36mconst[39m call2 [33m=[39m mockVersionService[33m.[39mcreateAutoSave[33m.[39mmock[33m.[39mcalls[[35m1[39m][33m;[39m
     [90m 677 |[39m
    [31m[1m>[22m[39m[90m 678 |[39m       expect(call1[[35m0[39m][33m.[39mcontent_hash)[33m.[39mnot[33m.[39mtoBe(call2[[35m0[39m][33m.[39mcontent_hash)[33m;[39m
     [90m     |[39m                   [31m[1m^[22m[39m
     [90m 679 |[39m     })[33m;[39m
     [90m 680 |[39m   })[33m;[39m
     [90m 681 |[39m })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:678:19)

FAIL src/__tests__/routes/sites.test.ts (9.346 s)
  ‚óè Console

    console.error
      Error fetching sites: Error: Database error
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\routes\sites.test.ts:101:53)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 37 |[39m     res[33m.[39mjson(sites)[33m;[39m
     [90m 38 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 39 |[39m     console[33m.[39merror([32m'Error fetching sites:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 40 |[39m     res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Failed to fetch sites'[39m })[33m;[39m
     [90m 41 |[39m   }
     [90m 42 |[39m })[33m;[39m[0m

      at src/routes/sites.ts:39:13

    console.error
      Error fetching domain sites: Error: Database error
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\routes\sites.test.ts:143:58)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 54 |[39m     res[33m.[39mjson(sites)[33m;[39m
     [90m 55 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 56 |[39m     console[33m.[39merror([32m'Error fetching domain sites:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 57 |[39m     res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Failed to fetch domain sites'[39m })[33m;[39m
     [90m 58 |[39m   }
     [90m 59 |[39m })[33m;[39m[0m

      at src/routes/sites.ts:56:13

    console.error
      Error fetching site: Error: Database error
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\routes\sites.test.ts:202:53)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 76 |[39m     res[33m.[39mjson(site)[33m;[39m
     [90m 77 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 78 |[39m     console[33m.[39merror([32m'Error fetching site:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 79 |[39m     res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Failed to fetch site'[39m })[33m;[39m
     [90m 80 |[39m   }
     [90m 81 |[39m })[33m;[39m[0m

      at src/routes/sites.ts:78:13

    console.error
      Error updating site: Error: Duplicate key
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\routes\sites.test.ts:343:21)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12) {
        constraint: 'unique_domain_base_path'
      }

    [0m [90m 132 |[39m       res[33m.[39mjson(site)[33m;[39m
     [90m 133 |[39m     } [36mcatch[39m (error[33m:[39m any) {
    [31m[1m>[22m[39m[90m 134 |[39m       console[33m.[39merror([32m'Error updating site:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 135 |[39m
     [90m 136 |[39m       [36mif[39m (error[33m.[39mconstraint [33m===[39m [32m'unique_domain_base_path'[39m) {
     [90m 137 |[39m         [36mreturn[39m res[33m.[39mstatus([35m409[39m)[33m.[39mjson({[0m

      at src/routes/sites.ts:134:15

    console.error
      Error updating site: Error: Generic error
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\routes\sites.test.ts:358:52)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 132 |[39m       res[33m.[39mjson(site)[33m;[39m
     [90m 133 |[39m     } [36mcatch[39m (error[33m:[39m any) {
    [31m[1m>[22m[39m[90m 134 |[39m       console[33m.[39merror([32m'Error updating site:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 135 |[39m
     [90m 136 |[39m       [36mif[39m (error[33m.[39mconstraint [33m===[39m [32m'unique_domain_base_path'[39m) {
     [90m 137 |[39m         [36mreturn[39m res[33m.[39mstatus([35m409[39m)[33m.[39mjson({[0m

      at src/routes/sites.ts:134:15

    console.error
      Error deleting site: Error: Cannot delete the last site for a domain
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\routes\sites.test.ts:401:9)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 162 |[39m     res[33m.[39mstatus([35m204[39m)[33m.[39msend()[33m;[39m
     [90m 163 |[39m   } [36mcatch[39m (error[33m:[39m any) {
    [31m[1m>[22m[39m[90m 164 |[39m     console[33m.[39merror([32m'Error deleting site:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 165 |[39m
     [90m 166 |[39m     [36mif[39m (error[33m.[39mmessage [33m===[39m [32m'Cannot delete the last site for a domain'[39m) {
     [90m 167 |[39m       [36mreturn[39m res[33m.[39mstatus([35m400[39m)[33m.[39mjson({ error[33m:[39m error[33m.[39mmessage })[33m;[39m[0m

      at src/routes/sites.ts:164:13

    console.error
      Error deleting site: Error: Generic error
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\routes\sites.test.ts:414:52)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 162 |[39m     res[33m.[39mstatus([35m204[39m)[33m.[39msend()[33m;[39m
     [90m 163 |[39m   } [36mcatch[39m (error[33m:[39m any) {
    [31m[1m>[22m[39m[90m 164 |[39m     console[33m.[39merror([32m'Error deleting site:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 165 |[39m
     [90m 166 |[39m     [36mif[39m (error[33m.[39mmessage [33m===[39m [32m'Cannot delete the last site for a domain'[39m) {
     [90m 167 |[39m       [36mreturn[39m res[33m.[39mstatus([35m400[39m)[33m.[39mjson({ error[33m:[39m error[33m.[39mmessage })[33m;[39m[0m

      at src/routes/sites.ts:164:13

    console.error
      Error getting site context: Error: Database error
          at Object.<anonymous> (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\src\__tests__\routes\sites.test.ts:503:66)
          at Promise.then.completed (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:316:40)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at _runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\runTest.js:444:34)
          at Object.worker (C:\Users\drago\DEVELOPMENT\dprogres-cms\backend\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 198 |[39m     })[33m;[39m
     [90m 199 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 200 |[39m     console[33m.[39merror([32m'Error getting site context:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 201 |[39m     res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ error[33m:[39m [32m'Failed to get site context'[39m })[33m;[39m
     [90m 202 |[39m   }
     [90m 203 |[39m })[33m;[39m[0m

      at src/routes/sites.ts:200:13

  ‚óè Sites Routes ‚Ä∫ POST /api/sites ‚Ä∫ should create a new site

    expected 201 "Created", got 400 "Bad Request"

    [0m [90m 235 |[39m         [33m.[39mpost([32m'/api/sites'[39m)
     [90m 236 |[39m         [33m.[39msend(validSiteData)
    [31m[1m>[22m[39m[90m 237 |[39m         [33m.[39mexpect([35m201[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 238 |[39m
     [90m 239 |[39m       expect(response[33m.[39mbody)[33m.[39mtoEqual({
     [90m 240 |[39m         [33m...[39mmockCreatedSite[33m,[39m[0m

      at Object.<anonymous> (src/__tests__/routes/sites.test.ts:237:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Sites Routes ‚Ä∫ POST /api/sites ‚Ä∫ should return 404 when domain not found

    expected 404 "Not Found", got 400 "Bad Request"

    [0m [90m 251 |[39m         [33m.[39mpost([32m'/api/sites'[39m)
     [90m 252 |[39m         [33m.[39msend(validSiteData)
    [31m[1m>[22m[39m[90m 253 |[39m         [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 254 |[39m
     [90m 255 |[39m       expect(response[33m.[39mbody)[33m.[39mtoEqual({ error[33m:[39m [32m'Domain not found'[39m })[33m;[39m
     [90m 256 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/sites.test.ts:253:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Sites Routes ‚Ä∫ POST /api/sites ‚Ä∫ should return 409 for duplicate base path

    expected 409 "Conflict", got 400 "Bad Request"

    [0m [90m 264 |[39m         [33m.[39mpost([32m'/api/sites'[39m)
     [90m 265 |[39m         [33m.[39msend(validSiteData)
    [31m[1m>[22m[39m[90m 266 |[39m         [33m.[39mexpect([35m409[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 267 |[39m
     [90m 268 |[39m       expect(response[33m.[39mbody)[33m.[39mtoEqual({
     [90m 269 |[39m         error[33m:[39m [32m'A site with this base path already exists for this domain'[39m[0m

      at Object.<anonymous> (src/__tests__/routes/sites.test.ts:266:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Sites Routes ‚Ä∫ POST /api/sites ‚Ä∫ should handle generic service errors

    expected 500 "Internal Server Error", got 400 "Bad Request"

    [0m [90m 277 |[39m         [33m.[39mpost([32m'/api/sites'[39m)
     [90m 278 |[39m         [33m.[39msend(validSiteData)
    [31m[1m>[22m[39m[90m 279 |[39m         [33m.[39mexpect([35m500[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 280 |[39m
     [90m 281 |[39m       expect(response[33m.[39mbody)[33m.[39mtoEqual({ error[33m:[39m [32m'Failed to create site'[39m })[33m;[39m
     [90m 282 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/sites.test.ts:279:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Summary of all failing tests
FAIL src/__tests__/services/VersionService.enhanced.test.ts (6.018 s)
  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Enhanced Version Creation ‚Ä∫ should create version with enhanced security validation

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "SELECT 1 FROM sites", [1, 1]
    Received
           1: "SET TRANSACTION ISOLATION LEVEL REPEATABLE READ"
           2: "BEGIN"
           3
              "SELECT get_next_version_number($1, $2, $3) as version_number",
              Array [
                1,
            +   "post",
                1,
              ],

    Number of calls: 7

    [0m [90m 230 |[39m
     [90m 231 |[39m       [90m// Verify site access validation was called[39m
    [31m[1m>[22m[39m[90m 232 |[39m       expect(mockQuery)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                         [31m[1m^[22m[39m
     [90m 233 |[39m         expect[33m.[39mstringContaining([32m'SELECT 1 FROM sites'[39m)[33m,[39m
     [90m 234 |[39m         [[35m1[39m[33m,[39m [35m1[39m]
     [90m 235 |[39m       )[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:232:25)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Enhanced Version Creation ‚Ä∫ should respect version limits

    expect(received).toContain(expected) // indexOf

    Expected substring: "Maximum version limit"
    Received string:    "Failed to validate site access"

    [0m [90m 258 |[39m
     [90m 259 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 260 |[39m       expect(result[33m.[39merror)[33m.[39mtoContain([32m'Maximum version limit'[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 261 |[39m     })[33m;[39m
     [90m 262 |[39m   })[33m;[39m
     [90m 263 |[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:260:28)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Enhanced Draft Operations ‚Ä∫ should create draft with proper version type

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 295 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m versionService[33m.[39mcreateDraft(input[33m,[39m [35m1[39m)[33m;[39m
     [90m 296 |[39m
    [31m[1m>[22m[39m[90m 297 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 298 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mversion_type)[33m.[39mtoBe([32m'draft'[39m)[33m;[39m
     [90m 299 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mis_current_draft)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 300 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:297:30)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Auto-Save Features ‚Ä∫ should create auto-save version and trigger pruning

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 334 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m versionService[33m.[39mautoSave(input[33m,[39m [35m1[39m)[33m;[39m
     [90m 335 |[39m
    [31m[1m>[22m[39m[90m 336 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 337 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mversion_type)[33m.[39mtoBe([32m'auto_save'[39m)[33m;[39m
     [90m 338 |[39m
     [90m 339 |[39m       [90m// Wait a bit for async pruning to be called[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:336:30)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Version Metrics ‚Ä∫ should calculate comprehensive metrics

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 363 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m versionService[33m.[39mgetVersionMetrics([35m1[39m[33m,[39m [33mContentType[39m[33m.[39m[33mPOST[39m[33m,[39m [35m1[39m)[33m;[39m
     [90m 364 |[39m
    [31m[1m>[22m[39m[90m 365 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 366 |[39m       expect(result[33m.[39mdata)[33m.[39mtoEqual({
     [90m 367 |[39m         total_versions[33m:[39m [35m25[39m[33m,[39m
     [90m 368 |[39m         draft_count[33m:[39m [35m5[39m[33m,[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:365:30)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Version Metrics ‚Ä∫ should use cache for subsequent requests

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 388 |[39m       [90m// First call[39m
     [90m 389 |[39m       [36mconst[39m result1 [33m=[39m [36mawait[39m versionService[33m.[39mgetVersionMetrics([35m1[39m[33m,[39m [33mContentType[39m[33m.[39m[33mPOST[39m[33m,[39m [35m1[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 390 |[39m       expect(result1[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 391 |[39m
     [90m 392 |[39m       [90m// Second call should use cache[39m
     [90m 393 |[39m       [36mconst[39m result2 [33m=[39m [36mawait[39m versionService[33m.[39mgetVersionMetrics([35m1[39m[33m,[39m [33mContentType[39m[33m.[39m[33mPOST[39m[33m,[39m [35m1[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:390:31)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Event System ‚Ä∫ should emit events on version creation

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"action": "created", "siteId": 1, "userId": 1}

    Number of calls: 0

    [0m [90m 432 |[39m       [36mawait[39m versionService[33m.[39mcreateVersion(input[33m,[39m [35m1[39m)[33m;[39m
     [90m 433 |[39m
    [31m[1m>[22m[39m[90m 434 |[39m       expect(eventHandler)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 435 |[39m         expect[33m.[39mobjectContaining({
     [90m 436 |[39m           action[33m:[39m [33mVersionAction[39m[33m.[39m[33mCREATED[39m[33m,[39m
     [90m 437 |[39m           userId[33m:[39m [35m1[39m[33m,[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:434:28)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Event System ‚Ä∫ should support any event handler

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"action": "created"}

    Number of calls: 0

    [0m [90m 472 |[39m       [36mawait[39m versionService[33m.[39mcreateVersion(input[33m,[39m [35m1[39m)[33m;[39m
     [90m 473 |[39m
    [31m[1m>[22m[39m[90m 474 |[39m       expect(anyEventHandler)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 475 |[39m         expect[33m.[39mobjectContaining({
     [90m 476 |[39m           action[33m:[39m [33mVersionAction[39m[33m.[39m[33mCREATED[39m
     [90m 477 |[39m         })[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:474:31)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Performance Features ‚Ä∫ should prune old auto-save versions

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 486 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m versionService[33m.[39mpruneOldAutoSaves([35m1[39m[33m,[39m [33mContentType[39m[33m.[39m[33mPOST[39m[33m,[39m [35m1[39m)[33m;[39m
     [90m 487 |[39m
    [31m[1m>[22m[39m[90m 488 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 489 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mdeleted_count)[33m.[39mtoBe([35m5[39m)[33m;[39m
     [90m 490 |[39m
     [90m 491 |[39m       expect(mockQuery)[33m.[39mtoHaveBeenCalledWith([0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:488:30)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Error Handling ‚Ä∫ should handle database connection errors

    expect(received).toContain(expected) // indexOf

    Expected substring: "Connection failed"
    Received string:    "Failed to validate site access"

    [0m [90m 524 |[39m
     [90m 525 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 526 |[39m       expect(result[33m.[39merror)[33m.[39mtoContain([32m'Connection failed'[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 527 |[39m     })[33m;[39m
     [90m 528 |[39m
     [90m 529 |[39m     it([32m'should rollback transactions on failure'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:526:28)

  ‚óè Enhanced VersionService - CV-003 ‚Ä∫ Error Handling ‚Ä∫ should rollback transactions on failure

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "ROLLBACK"

    Number of calls: 0

    [0m [90m 543 |[39m
     [90m 544 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 545 |[39m       expect(mockClient[33m.[39mquery)[33m.[39mtoHaveBeenCalledWith([32m'ROLLBACK'[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 546 |[39m       expect(mockClient[33m.[39mrelease)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m 547 |[39m     })[33m;[39m
     [90m 548 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.enhanced.test.ts:545:32)

FAIL src/__tests__/versions.test.ts (6.846 s)
  ‚óè Version API Endpoints ‚Ä∫ GET /api/content/:contentType/:contentId/versions ‚Ä∫ should list versions for a content item

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 171 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 172 |[39m
    [31m[1m>[22m[39m[90m 173 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 174 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 175 |[39m       expect(response[33m.[39mbody[33m.[39mdata)[33m.[39mtoHaveLength([35m2[39m)[33m;[39m
     [90m 176 |[39m       expect(response[33m.[39mbody[33m.[39mpagination)[33m.[39mtoBeDefined()[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:173:31)

  ‚óè Version API Endpoints ‚Ä∫ GET /api/content/:contentType/:contentId/versions ‚Ä∫ should return 404 for non-existent content

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 500

    [0m [90m 192 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 193 |[39m
    [31m[1m>[22m[39m[90m 194 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 195 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'not found'[39m)[33m;[39m
     [90m 196 |[39m     })[33m;[39m
     [90m 197 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:194:31)

  ‚óè Version API Endpoints ‚Ä∫ POST /api/content/:contentType/:contentId/versions ‚Ä∫ should create a new version

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 401

    [0m [90m 210 |[39m         })[33m;[39m
     [90m 211 |[39m
    [31m[1m>[22m[39m[90m 212 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 213 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 214 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mtitle)[33m.[39mtoBe([32m'Test Version'[39m)[33m;[39m
     [90m 215 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:212:31)

  ‚óè Version API Endpoints ‚Ä∫ POST /api/content/:contentType/:contentId/versions ‚Ä∫ should validate required fields

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 401

    [0m [90m 225 |[39m         })[33m;[39m
     [90m 226 |[39m
    [31m[1m>[22m[39m[90m 227 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 228 |[39m     })[33m;[39m
     [90m 229 |[39m
     [90m 230 |[39m     it([32m'should check content ownership for authors'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:227:31)

  ‚óè Version API Endpoints ‚Ä∫ POST /api/content/:contentType/:contentId/versions ‚Ä∫ should check content ownership for authors

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 401

    [0m [90m 248 |[39m         })[33m;[39m
     [90m 249 |[39m
    [31m[1m>[22m[39m[90m 250 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m403[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 251 |[39m     })[33m;[39m
     [90m 252 |[39m   })[33m;[39m
     [90m 253 |[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:250:31)

  ‚óè Version API Endpoints ‚Ä∫ GET /api/versions/:versionId ‚Ä∫ should get a specific version

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 260 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 261 |[39m
    [31m[1m>[22m[39m[90m 262 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 263 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 264 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mid)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m 265 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:262:31)

  ‚óè Version API Endpoints ‚Ä∫ GET /api/versions/:versionId ‚Ä∫ should check version access

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 275 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 276 |[39m
    [31m[1m>[22m[39m[90m 277 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m [90m// GET is allowed for all authenticated users[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 278 |[39m     })[33m;[39m
     [90m 279 |[39m   })[33m;[39m
     [90m 280 |[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:277:31)

  ‚óè Version API Endpoints ‚Ä∫ PUT /api/versions/:versionId ‚Ä∫ should update a draft version

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 290 |[39m         })[33m;[39m
     [90m 291 |[39m
    [31m[1m>[22m[39m[90m 292 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 293 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 294 |[39m     })[33m;[39m
     [90m 295 |[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:292:31)

  ‚óè Version API Endpoints ‚Ä∫ PUT /api/versions/:versionId ‚Ä∫ should prevent updating published versions

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 401

    [0m [90m 310 |[39m         })[33m;[39m
     [90m 311 |[39m
    [31m[1m>[22m[39m[90m 312 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 313 |[39m     })[33m;[39m
     [90m 314 |[39m   })[33m;[39m
     [90m 315 |[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:312:31)

  ‚óè Version API Endpoints ‚Ä∫ POST /api/versions/:versionId/publish ‚Ä∫ should publish a version

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 322 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 323 |[39m
    [31m[1m>[22m[39m[90m 324 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 325 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 326 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'published successfully'[39m)[33m;[39m
     [90m 327 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:324:31)

  ‚óè Version API Endpoints ‚Ä∫ POST /api/versions/:versionId/revert ‚Ä∫ should create new draft from version

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 350 |[39m         })[33m;[39m
     [90m 351 |[39m
    [31m[1m>[22m[39m[90m 352 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 353 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 354 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'created new draft'[39m)[33m;[39m
     [90m 355 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:352:31)

  ‚óè Version API Endpoints ‚Ä∫ DELETE /api/versions/:versionId ‚Ä∫ should delete a version

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 364 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 365 |[39m
    [31m[1m>[22m[39m[90m 366 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 367 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 368 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'deleted successfully'[39m)[33m;[39m
     [90m 369 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:366:31)

  ‚óè Version API Endpoints ‚Ä∫ GET /api/content/:contentType/:contentId/versions/latest ‚Ä∫ should get latest draft version

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 378 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 379 |[39m
    [31m[1m>[22m[39m[90m 380 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 381 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 382 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mtitle)[33m.[39mtoBe([32m'Latest Draft'[39m)[33m;[39m
     [90m 383 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:380:31)

  ‚óè Version API Endpoints ‚Ä∫ GET /api/content/:contentType/:contentId/versions/latest ‚Ä∫ should get published version

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 390 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 391 |[39m
    [31m[1m>[22m[39m[90m 392 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 393 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 394 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mtitle)[33m.[39mtoBe([32m'Published Version'[39m)[33m;[39m
     [90m 395 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:392:31)

  ‚óè Version API Endpoints ‚Ä∫ GET /api/versions/:versionId/diff ‚Ä∫ should compare two versions

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 404 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 405 |[39m
    [31m[1m>[22m[39m[90m 406 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 407 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 408 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mchanges)[33m.[39mtoHaveLength([35m1[39m)[33m;[39m
     [90m 409 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:406:31)

  ‚óè Version API Endpoints ‚Ä∫ GET /api/versions/:versionId/diff ‚Ä∫ should validate versions belong to same content

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 404

    [0m [90m 427 |[39m         [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer ${token}`[39m)[33m;[39m
     [90m 428 |[39m
    [31m[1m>[22m[39m[90m 429 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 430 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'same content'[39m)[33m;[39m
     [90m 431 |[39m     })[33m;[39m
     [90m 432 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/versions.test.ts:429:31)

FAIL src/__tests__/services/VersionService.autosave.test.ts (7.137 s)
  ‚óè VersionService Auto-Save Features ‚Ä∫ createAutoSave ‚Ä∫ should create auto-save version successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 136 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mcreateAutoSave(baseInput[33m,[39m testUserId[33m,[39m testSiteId)[33m;[39m
     [90m 137 |[39m
    [31m[1m>[22m[39m[90m 138 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 139 |[39m       expect(result[33m.[39mdata)[33m.[39mtoBeDefined()[33m;[39m
     [90m 140 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mversion_type)[33m.[39mtoBe([32m'auto_save'[39m)[33m;[39m
     [90m 141 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mcontent_hash)[33m.[39mtoBe(baseInput[33m.[39mcontent_hash)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:138:30)

  ‚óè VersionService Auto-Save Features ‚Ä∫ createAutoSave ‚Ä∫ should detect content changes via hash comparison

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 165 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mcreateAutoSave(baseInput[33m,[39m testUserId[33m,[39m testSiteId)[33m;[39m
     [90m 166 |[39m
    [31m[1m>[22m[39m[90m 167 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 168 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mcontent_hash)[33m.[39mtoBe(baseInput[33m.[39mcontent_hash)[33m;[39m
     [90m 169 |[39m     })[33m;[39m
     [90m 170 |[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:167:30)

  ‚óè VersionService Auto-Save Features ‚Ä∫ createAutoSave ‚Ä∫ should handle missing content hash gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 195 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mcreateAutoSave(inputWithoutHash[33m,[39m testUserId[33m,[39m testSiteId)[33m;[39m
     [90m 196 |[39m
    [31m[1m>[22m[39m[90m 197 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 198 |[39m       [90m// Should proceed without hash validation[39m
     [90m 199 |[39m       expect(mockQuery)[33m.[39mtoHaveBeenCalledWith([32m'BEGIN'[39m)[33m;[39m
     [90m 200 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:197:30)

  ‚óè VersionService Auto-Save Features ‚Ä∫ createAutoSave ‚Ä∫ should trigger cleanup of old auto-saves after successful creation

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 213 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mcreateAutoSave(baseInput[33m,[39m testUserId[33m,[39m testSiteId)[33m;[39m
     [90m 214 |[39m
    [31m[1m>[22m[39m[90m 215 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 216 |[39m
     [90m 217 |[39m       [90m// Wait for async cleanup to be called[39m
     [90m 218 |[39m       [36mawait[39m [36mnew[39m [33mPromise[39m(resolve [33m=>[39m setTimeout(resolve[33m,[39m [35m10[39m))[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:215:30)

  ‚óè VersionService Auto-Save Features ‚Ä∫ hasUnsavedChanges ‚Ä∫ should query for latest non-auto-save version

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

    - StringContaining "version_type != 'auto_save'",
    + "
            SELECT content_hash
            FROM content_versions
            WHERE site_id = $1
              AND content_type = $2
              AND content_id = $3
              AND content_hash IS NOT NULL
            ORDER BY created_at DESC
            LIMIT 1
          ",
      [1, "post", 123],

    Number of calls: 1

    [0m [90m 397 |[39m       )[33m;[39m
     [90m 398 |[39m
    [31m[1m>[22m[39m[90m 399 |[39m       expect(mockQuery)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                         [31m[1m^[22m[39m
     [90m 400 |[39m         expect[33m.[39mstringContaining([32m"version_type != 'auto_save'"[39m)[33m,[39m
     [90m 401 |[39m         [testSiteId[33m,[39m [32m'post'[39m[33m,[39m testContentId]
     [90m 402 |[39m       )[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:399:25)

  ‚óè VersionService Auto-Save Features ‚Ä∫ cleanupOldAutoSaves ‚Ä∫ should order by creation date descending for deletion

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "ORDER BY created_at DESC", Anything
    Received: "
            DELETE FROM content_versions
            WHERE site_id = $1
              AND content_type = $2
              AND content_id = $3
              AND version_type = 'auto_save'
              AND created_at < $4
              AND NOT is_current_draft
              AND NOT is_current_published", [1, "post", 123, 2025-10-24T09:45:08.641Z]

    Number of calls: 1

    [0m [90m 504 |[39m       )[33m;[39m
     [90m 505 |[39m
    [31m[1m>[22m[39m[90m 506 |[39m       expect(mockQuery)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                         [31m[1m^[22m[39m
     [90m 507 |[39m         expect[33m.[39mstringContaining([32m'ORDER BY created_at DESC'[39m)[33m,[39m
     [90m 508 |[39m         expect[33m.[39manything()
     [90m 509 |[39m       )[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:506:25)

  ‚óè VersionService Auto-Save Features ‚Ä∫ Auto-Save Integration Scenarios ‚Ä∫ should handle rapid successive auto-save attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 578 |[39m       [36mconst[39m result2 [33m=[39m [36mawait[39m service[33m.[39mcreateAutoSave(input2[33m,[39m testUserId[33m,[39m testSiteId)[33m;[39m
     [90m 579 |[39m
    [31m[1m>[22m[39m[90m 580 |[39m       expect(result1[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 581 |[39m       expect(result2[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 582 |[39m       expect(result1[33m.[39mdata[33m?[39m[33m.[39mcontent_hash)[33m.[39mtoBe([32m'hash1'[39m)[33m;[39m
     [90m 583 |[39m       expect(result2[33m.[39mdata[33m?[39m[33m.[39mcontent_hash)[33m.[39mtoBe([32m'hash2'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:580:31)

  ‚óè VersionService Auto-Save Features ‚Ä∫ Auto-Save Integration Scenarios ‚Ä∫ should handle auto-save creation with concurrent manual saves

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 606 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mcreateAutoSave(autoSaveInput[33m,[39m testUserId[33m,[39m testSiteId)[33m;[39m
     [90m 607 |[39m
    [31m[1m>[22m[39m[90m 608 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 609 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mcontent_hash)[33m.[39mtoBe([32m'auto_hash'[39m)[33m;[39m
     [90m 610 |[39m     })[33m;[39m
     [90m 611 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.autosave.test.ts:608:30)

FAIL src/__tests__/services/VersionService.test.ts (8.311 s)
  ‚óè VersionService ‚Ä∫ createVersion ‚Ä∫ should create a new version successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m  95 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mcreateVersion(input[33m,[39m [35m1[39m)[33m;[39m
     [90m  96 |[39m
    [31m[1m>[22m[39m[90m  97 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m  98 |[39m       expect(result[33m.[39mdata)[33m.[39mtoEqual(mockVersion)[33m;[39m
     [90m  99 |[39m       expect(mockClient[33m.[39mquery)[33m.[39mtoHaveBeenCalledWith([32m'BEGIN'[39m)[33m;[39m
     [90m 100 |[39m       expect(mockClient[33m.[39mquery)[33m.[39mtoHaveBeenCalledWith([32m'COMMIT'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:97:30)

  ‚óè VersionService ‚Ä∫ createVersion ‚Ä∫ should rollback on error

    expect(received).toBe(expected) // Object.is equality

    Expected: "Database error"
    Received: "Failed to validate site access"

    [0m [90m 119 |[39m
     [90m 120 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 121 |[39m       expect(result[33m.[39merror)[33m.[39mtoBe([32m'Database error'[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 122 |[39m       expect(mockClient[33m.[39mquery)[33m.[39mtoHaveBeenCalledWith([32m'ROLLBACK'[39m)[33m;[39m
     [90m 123 |[39m       expect(mockClient[33m.[39mrelease)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m 124 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:121:28)

  ‚óè VersionService ‚Ä∫ createVersion ‚Ä∫ should detect changed fields correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 155 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mcreateVersion(input[33m,[39m [35m1[39m)[33m;[39m
     [90m 156 |[39m
    [31m[1m>[22m[39m[90m 157 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 158 |[39m       expect(result[33m.[39mmetadata[33m?[39m[33m.[39mversion_number)[33m.[39mtoBe([35m2[39m)[33m;[39m
     [90m 159 |[39m     })[33m;[39m
     [90m 160 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:157:30)

  ‚óè VersionService ‚Ä∫ publishVersion ‚Ä∫ should publish a version successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 285 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mpublishVersion([35m1[39m[33m,[39m [35m1[39m)[33m;[39m
     [90m 286 |[39m
    [31m[1m>[22m[39m[90m 287 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 288 |[39m       expect(mockClient[33m.[39mquery)[33m.[39mtoHaveBeenCalledWith([32m'BEGIN'[39m)[33m;[39m
     [90m 289 |[39m       expect(mockClient[33m.[39mquery)[33m.[39mtoHaveBeenCalledWith([32m'COMMIT'[39m)[33m;[39m
     [90m 290 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:287:30)

  ‚óè VersionService ‚Ä∫ publishVersion ‚Ä∫ should handle version not found

    expect(received).toBe(expected) // Object.is equality

    Expected: "Version not found"
    Received: "Cannot read properties of undefined (reading 'rows')"

    [0m [90m 298 |[39m
     [90m 299 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 300 |[39m       expect(result[33m.[39merror)[33m.[39mtoBe([32m'Version not found'[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 301 |[39m       expect(mockClient[33m.[39mquery)[33m.[39mtoHaveBeenCalledWith([32m'ROLLBACK'[39m)[33m;[39m
     [90m 302 |[39m     })[33m;[39m
     [90m 303 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:300:28)

  ‚óè VersionService ‚Ä∫ revertToVersion ‚Ä∫ should revert to a previous version

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 351 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m service[33m.[39mrevertToVersion([35m1[39m[33m,[39m [35m1[39m)[33m;[39m
     [90m 352 |[39m
    [31m[1m>[22m[39m[90m 353 |[39m       expect(result[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 354 |[39m       expect(result[33m.[39mdata[33m?[39m[33m.[39mversion_number)[33m.[39mtoBe([35m3[39m)[33m;[39m
     [90m 355 |[39m     })[33m;[39m
     [90m 356 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/VersionService.test.ts:353:30)

FAIL src/__tests__/integration/cv007-diff.integration.test.ts (8.695 s)
  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ GET /api/versions/compare ‚Ä∫ should enforce site isolation

    expected 400 "Bad Request", got 200 "OK"

    [0m [90m 118 |[39m           version_b_id[33m:[39m [35m2[39m
     [90m 119 |[39m         })
    [31m[1m>[22m[39m[90m 120 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 121 |[39m
     [90m 122 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 123 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'site isolation'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:120:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ GET /api/versions/compare ‚Ä∫ should validate user access

    expected 400 "Bad Request", got 200 "OK"

    [0m [90m 138 |[39m           version_b_id[33m:[39m [35m2[39m
     [90m 139 |[39m         })
    [31m[1m>[22m[39m[90m 140 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 141 |[39m
     [90m 142 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 143 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Access denied'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:140:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ GET /api/versions/:id1/diff/:id2 ‚Ä∫ should get diff between two versions

    expected 200 "OK", got 400 "Bad Request"

    [0m [90m 174 |[39m         [33m.[39m[36mget[39m([32m'/api/versions/1/diff/2'[39m)
     [90m 175 |[39m         [33m.[39mquery({ format[33m:[39m [32m'json'[39m })
    [31m[1m>[22m[39m[90m 176 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 177 |[39m
     [90m 178 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 179 |[39m       expect(response[33m.[39mbody[33m.[39mdata)[33m.[39mtoBeDefined()[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:176:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ POST /api/versions/diff/export ‚Ä∫ should export diff as JSON

    expected 200 "OK", got 400 "Bad Request"

    [0m [90m 217 |[39m           include_statistics[33m:[39m [36mtrue[39m
     [90m 218 |[39m         })
    [31m[1m>[22m[39m[90m 219 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 220 |[39m
     [90m 221 |[39m       [90m// Response should be JSON export[39m
     [90m 222 |[39m       [36mconst[39m exportData [33m=[39m [33mJSON[39m[33m.[39mparse(response[33m.[39mtext)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:219:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ POST /api/versions/diff/export ‚Ä∫ should export diff as HTML

    expected 200 "OK", got 400 "Bad Request"

    [0m [90m 257 |[39m           include_metadata[33m:[39m [36mtrue[39m
     [90m 258 |[39m         })
    [31m[1m>[22m[39m[90m 259 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 260 |[39m
     [90m 261 |[39m       [90m// Response should be HTML[39m
     [90m 262 |[39m       expect(response[33m.[39mtext)[33m.[39mtoContain([32m'<!DOCTYPE html>'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:259:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ GET /api/versions/:id/changes-summary ‚Ä∫ should get changes summary for a version

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 299 |[39m         [33m.[39m[36mget[39m([32m'/api/versions/2/changes-summary'[39m)
     [90m 300 |[39m         [33m.[39mquery({ compare_with[33m:[39m [32m'previous'[39m })
    [31m[1m>[22m[39m[90m 301 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 302 |[39m
     [90m 303 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 304 |[39m       expect(response[33m.[39mbody[33m.[39mdata)[33m.[39mtoBeDefined()[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:301:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ GET /api/versions/history/:contentType/:contentId ‚Ä∫ should get version history with diff summaries

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 368 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 369 |[39m         [33m.[39m[36mget[39m([32m'/api/versions/history/post/1'[39m)
    [31m[1m>[22m[39m[90m 370 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 371 |[39m
     [90m 372 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 373 |[39m       expect(response[33m.[39mbody[33m.[39mdata)[33m.[39mtoBeDefined()[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:370:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè CV-007 Version Comparison Integration Tests ‚Ä∫ GET /api/versions/history/:contentType/:contentId ‚Ä∫ should return 404 when no versions found

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 386 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 387 |[39m         [33m.[39m[36mget[39m([32m'/api/versions/history/post/999'[39m)
    [31m[1m>[22m[39m[90m 388 |[39m         [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 389 |[39m
     [90m 390 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 391 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'No versions found'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/integration/cv007-diff.integration.test.ts:388:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

FAIL src/__tests__/routes/autosave.test.ts (9.087 s)
  ‚óè Auto-Save API Routes ‚Ä∫ POST /api/content/:contentType/:contentId/autosave ‚Ä∫ should create auto-save successfully

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 146 |[39m         [33m.[39mpost([32m'/api/content/post/1/autosave'[39m)
     [90m 147 |[39m         [33m.[39msend(validAutoSaveData)
    [31m[1m>[22m[39m[90m 148 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 149 |[39m
     [90m 150 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 151 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mversion)[33m.[39mtoEqual(mockAutoSaveResult[33m.[39mdata)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:148:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ POST /api/content/:contentType/:contentId/autosave ‚Ä∫ should handle no changes detected gracefully

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 176 |[39m         [33m.[39mpost([32m'/api/content/post/1/autosave'[39m)
     [90m 177 |[39m         [33m.[39msend(validAutoSaveData)
    [31m[1m>[22m[39m[90m 178 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 179 |[39m
     [90m 180 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 181 |[39m       expect(response[33m.[39mbody[33m.[39mdata)[33m.[39mtoBeNull()[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:178:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ POST /api/content/:contentType/:contentId/autosave ‚Ä∫ should handle VersionService errors

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 203 |[39m         [33m.[39mpost([32m'/api/content/post/1/autosave'[39m)
     [90m 204 |[39m         [33m.[39msend(validAutoSaveData)
    [31m[1m>[22m[39m[90m 205 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 206 |[39m
     [90m 207 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoBe([32m'Database connection failed'[39m)[33m;[39m
     [90m 208 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:205:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ POST /api/content/:contentType/:contentId/autosave ‚Ä∫ should generate content hash from request data

    TypeError: Cannot read properties of undefined (reading '0')

    [0m [90m 230 |[39m
     [90m 231 |[39m       [36mconst[39m createCall [33m=[39m mockVersionService[33m.[39mcreateAutoSave[33m.[39mmock[33m.[39mcalls[[35m0[39m][33m;[39m
    [31m[1m>[22m[39m[90m 232 |[39m       [36mconst[39m inputData [33m=[39m createCall[[35m0[39m][33m;[39m
     [90m     |[39m                                   [31m[1m^[22m[39m
     [90m 233 |[39m
     [90m 234 |[39m       expect(inputData[33m.[39mcontent_hash)[33m.[39mtoBeDefined()[33m;[39m
     [90m 235 |[39m       expect([36mtypeof[39m inputData[33m.[39mcontent_hash)[33m.[39mtoBe([32m'string'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:232:35)

  ‚óè Auto-Save API Routes ‚Ä∫ POST /api/content/:contentType/:contentId/autosave ‚Ä∫ should work with page content type

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 246 |[39m         [33m.[39mpost([32m'/api/content/page/1/autosave'[39m)
     [90m 247 |[39m         [33m.[39msend(validAutoSaveData)
    [31m[1m>[22m[39m[90m 248 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 249 |[39m
     [90m 250 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 251 |[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:248:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ POST /api/content/:contentType/:contentId/autosave ‚Ä∫ should use default site_id when not found

    TypeError: Cannot read properties of undefined (reading '0')

    [0m [90m 269 |[39m
     [90m 270 |[39m       [36mconst[39m createCall [33m=[39m mockVersionService[33m.[39mcreateAutoSave[33m.[39mmock[33m.[39mcalls[[35m0[39m][33m;[39m
    [31m[1m>[22m[39m[90m 271 |[39m       expect(createCall[[35m0[39m][33m.[39msite_id)[33m.[39mtoBe([35m1[39m)[33m;[39m [90m// Default site ID[39m
     [90m     |[39m                        [31m[1m^[22m[39m
     [90m 272 |[39m       expect(createCall[[35m2[39m])[33m.[39mtoBe([35m1[39m)[33m;[39m [90m// Site ID parameter[39m
     [90m 273 |[39m     })[33m;[39m
     [90m 274 |[39m   })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:271:24)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/latest ‚Ä∫ should retrieve latest auto-save successfully

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 304 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 305 |[39m         [33m.[39m[36mget[39m([32m'/api/content/post/1/autosave/latest'[39m)
    [31m[1m>[22m[39m[90m 306 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 307 |[39m
     [90m 308 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 309 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mversion)[33m.[39mtoEqual(mockAutoSave)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:306:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/latest ‚Ä∫ should detect newer manual save

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 337 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 338 |[39m         [33m.[39m[36mget[39m([32m'/api/content/post/1/autosave/latest'[39m)
    [31m[1m>[22m[39m[90m 339 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 340 |[39m
     [90m 341 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mhas_newer_manual_save)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 342 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:339:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/latest ‚Ä∫ should return null when no auto-save exists

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 354 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 355 |[39m         [33m.[39m[36mget[39m([32m'/api/content/post/1/autosave/latest'[39m)
    [31m[1m>[22m[39m[90m 356 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 357 |[39m
     [90m 358 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 359 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mversion)[33m.[39mtoBeNull()[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:356:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/latest ‚Ä∫ should handle VersionService errors

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 369 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 370 |[39m         [33m.[39m[36mget[39m([32m'/api/content/post/1/autosave/latest'[39m)
    [31m[1m>[22m[39m[90m 371 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 372 |[39m
     [90m 373 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoBe([32m'Database query failed'[39m)[33m;[39m
     [90m 374 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:371:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/latest ‚Ä∫ should return 404 for non-existent content

    expected 404 "Not Found", got 500 "Internal Server Error"

    [0m [90m 379 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 380 |[39m         [33m.[39m[36mget[39m([32m'/api/content/post/999/autosave/latest'[39m)
    [31m[1m>[22m[39m[90m 381 |[39m         [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 382 |[39m
     [90m 383 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoBe([32m'post not found'[39m)[33m;[39m
     [90m 384 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:381:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/status ‚Ä∫ should check unsaved changes status successfully

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 408 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 409 |[39m         [33m.[39m[36mget[39m([32m`/api/content/post/1/autosave/status?content_hash=${testContentHash}`[39m)
    [31m[1m>[22m[39m[90m 410 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 411 |[39m
     [90m 412 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 413 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mhas_unsaved_changes)[33m.[39mtoBe([36mtrue[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:410:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/status ‚Ä∫ should return false for no unsaved changes

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 436 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 437 |[39m         [33m.[39m[36mget[39m([32m`/api/content/post/1/autosave/status?content_hash=${testContentHash}`[39m)
    [31m[1m>[22m[39m[90m 438 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 439 |[39m
     [90m 440 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mhas_unsaved_changes)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 441 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:438:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/status ‚Ä∫ should handle no existing versions

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 461 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 462 |[39m         [33m.[39m[36mget[39m([32m`/api/content/post/1/autosave/status?content_hash=${testContentHash}`[39m)
    [31m[1m>[22m[39m[90m 463 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 464 |[39m
     [90m 465 |[39m       expect(response[33m.[39mbody[33m.[39mdata[33m.[39mlatest_version_number)[33m.[39mtoBe([35m0[39m)[33m;[39m
     [90m 466 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:463:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ GET /api/content/:contentType/:contentId/autosave/status ‚Ä∫ should handle VersionService errors

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 474 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 475 |[39m         [33m.[39m[36mget[39m([32m`/api/content/post/1/autosave/status?content_hash=${testContentHash}`[39m)
    [31m[1m>[22m[39m[90m 476 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 477 |[39m
     [90m 478 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoBe([32m'Hash comparison failed'[39m)[33m;[39m
     [90m 479 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:476:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ DELETE /api/content/:contentType/:contentId/autosave/cleanup ‚Ä∫ should cleanup old auto-saves successfully

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 495 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 496 |[39m         [33m.[39m[36mdelete[39m([32m'/api/content/post/1/autosave/cleanup'[39m)
    [31m[1m>[22m[39m[90m 497 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 498 |[39m
     [90m 499 |[39m       expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 500 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoBe([32m'Cleaned up 3 old auto-saves'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:497:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ DELETE /api/content/:contentType/:contentId/autosave/cleanup ‚Ä∫ should handle zero deletions

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 515 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 516 |[39m         [33m.[39m[36mdelete[39m([32m'/api/content/post/1/autosave/cleanup'[39m)
    [31m[1m>[22m[39m[90m 517 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 518 |[39m
     [90m 519 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoBe([32m'Cleaned up 0 old auto-saves'[39m)[33m;[39m
     [90m 520 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:517:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ DELETE /api/content/:contentType/:contentId/autosave/cleanup ‚Ä∫ should handle missing deleted_count in response

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 528 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 529 |[39m         [33m.[39m[36mdelete[39m([32m'/api/content/post/1/autosave/cleanup'[39m)
    [31m[1m>[22m[39m[90m 530 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 531 |[39m
     [90m 532 |[39m       expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoBe([32m'Cleaned up 0 old auto-saves'[39m)[33m;[39m
     [90m 533 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:530:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ DELETE /api/content/:contentType/:contentId/autosave/cleanup ‚Ä∫ should handle VersionService errors

    expected 400 "Bad Request", got 500 "Internal Server Error"

    [0m [90m 541 |[39m       [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 542 |[39m         [33m.[39m[36mdelete[39m([32m'/api/content/post/1/autosave/cleanup'[39m)
    [31m[1m>[22m[39m[90m 543 |[39m         [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 544 |[39m
     [90m 545 |[39m       expect(response[33m.[39mbody[33m.[39merror)[33m.[39mtoBe([32m'Cleanup operation failed'[39m)[33m;[39m
     [90m 546 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:543:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ DELETE /api/content/:contentType/:contentId/autosave/cleanup ‚Ä∫ should require content access permissions

    expected 200 "OK", got 500 "Internal Server Error"

    [0m [90m 569 |[39m       [36mawait[39m request(app)
     [90m 570 |[39m         [33m.[39m[36mdelete[39m([32m'/api/content/post/1/autosave/cleanup'[39m)
    [31m[1m>[22m[39m[90m 571 |[39m         [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 572 |[39m
     [90m 573 |[39m       [90m// Verify middleware was called[39m
     [90m 574 |[39m       expect(mockCheckContentAccess)[33m.[39mtoHaveBeenCalled()[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:571:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Auto-Save API Routes ‚Ä∫ Content Hash Generation ‚Ä∫ should generate deterministic hashes for same content

    TypeError: Cannot read properties of undefined (reading '0')

    [0m [90m 653 |[39m       [36mconst[39m call2 [33m=[39m mockVersionService[33m.[39mcreateAutoSave[33m.[39mmock[33m.[39mcalls[[35m1[39m][33m;[39m
     [90m 654 |[39m
    [31m[1m>[22m[39m[90m 655 |[39m       expect(call1[[35m0[39m][33m.[39mcontent_hash)[33m.[39mtoBe(call2[[35m0[39m][33m.[39mcontent_hash)[33m;[39m
     [90m     |[39m                   [31m[1m^[22m[39m
     [90m 656 |[39m     })[33m;[39m
     [90m 657 |[39m
     [90m 658 |[39m     it([32m'should generate different hashes for different content'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:655:19)

  ‚óè Auto-Save API Routes ‚Ä∫ Content Hash Generation ‚Ä∫ should generate different hashes for different content

    TypeError: Cannot read properties of undefined (reading '0')

    [0m [90m 676 |[39m       [36mconst[39m call2 [33m=[39m mockVersionService[33m.[39mcreateAutoSave[33m.[39mmock[33m.[39mcalls[[35m1[39m][33m;[39m
     [90m 677 |[39m
    [31m[1m>[22m[39m[90m 678 |[39m       expect(call1[[35m0[39m][33m.[39mcontent_hash)[33m.[39mnot[33m.[39mtoBe(call2[[35m0[39m][33m.[39mcontent_hash)[33m;[39m
     [90m     |[39m                   [31m[1m^[22m[39m
     [90m 679 |[39m     })[33m;[39m
     [90m 680 |[39m   })[33m;[39m
     [90m 681 |[39m })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/autosave.test.ts:678:19)

FAIL src/__tests__/routes/sites.test.ts (9.346 s)
  ‚óè Sites Routes ‚Ä∫ POST /api/sites ‚Ä∫ should create a new site

    expected 201 "Created", got 400 "Bad Request"

    [0m [90m 235 |[39m         [33m.[39mpost([32m'/api/sites'[39m)
     [90m 236 |[39m         [33m.[39msend(validSiteData)
    [31m[1m>[22m[39m[90m 237 |[39m         [33m.[39mexpect([35m201[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 238 |[39m
     [90m 239 |[39m       expect(response[33m.[39mbody)[33m.[39mtoEqual({
     [90m 240 |[39m         [33m...[39mmockCreatedSite[33m,[39m[0m

      at Object.<anonymous> (src/__tests__/routes/sites.test.ts:237:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Sites Routes ‚Ä∫ POST /api/sites ‚Ä∫ should return 404 when domain not found

    expected 404 "Not Found", got 400 "Bad Request"

    [0m [90m 251 |[39m         [33m.[39mpost([32m'/api/sites'[39m)
     [90m 252 |[39m         [33m.[39msend(validSiteData)
    [31m[1m>[22m[39m[90m 253 |[39m         [33m.[39mexpect([35m404[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 254 |[39m
     [90m 255 |[39m       expect(response[33m.[39mbody)[33m.[39mtoEqual({ error[33m:[39m [32m'Domain not found'[39m })[33m;[39m
     [90m 256 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/sites.test.ts:253:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Sites Routes ‚Ä∫ POST /api/sites ‚Ä∫ should return 409 for duplicate base path

    expected 409 "Conflict", got 400 "Bad Request"

    [0m [90m 264 |[39m         [33m.[39mpost([32m'/api/sites'[39m)
     [90m 265 |[39m         [33m.[39msend(validSiteData)
    [31m[1m>[22m[39m[90m 266 |[39m         [33m.[39mexpect([35m409[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 267 |[39m
     [90m 268 |[39m       expect(response[33m.[39mbody)[33m.[39mtoEqual({
     [90m 269 |[39m         error[33m:[39m [32m'A site with this base path already exists for this domain'[39m[0m

      at Object.<anonymous> (src/__tests__/routes/sites.test.ts:266:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)

  ‚óè Sites Routes ‚Ä∫ POST /api/sites ‚Ä∫ should handle generic service errors

    expected 500 "Internal Server Error", got 400 "Bad Request"

    [0m [90m 277 |[39m         [33m.[39mpost([32m'/api/sites'[39m)
     [90m 278 |[39m         [33m.[39msend(validSiteData)
    [31m[1m>[22m[39m[90m 279 |[39m         [33m.[39mexpect([35m500[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 280 |[39m
     [90m 281 |[39m       expect(response[33m.[39mbody)[33m.[39mtoEqual({ error[33m:[39m [32m'Failed to create site'[39m })[33m;[39m
     [90m 282 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/routes/sites.test.ts:279:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:252:14)
      at node_modules/supertest/lib/test.js:308:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:285:13)
      at Test.assert (node_modules/supertest/lib/test.js:164:23)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)


Test Suites: 7 failed, 22 passed, 29 total
Tests:       75 failed, 465 passed, 540 total
Snapshots:   0 total
Time:        11.109 s, estimated 26 s
Ran all test suites.
